/*
Deployment script for CITestDatabase

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "CITestDatabase"
:setvar DefaultFilePrefix "CITestDatabase"
:setvar DefaultDataPath ""
:setvar DefaultLogPath ""

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [master];


GO

IF (DB_ID(N'$(DatabaseName)') IS NOT NULL) 
BEGIN
    ALTER DATABASE [$(DatabaseName)]
    SET SINGLE_USER WITH ROLLBACK IMMEDIATE;
    DROP DATABASE [$(DatabaseName)];
END

GO
PRINT N'Creating $(DatabaseName)...'
GO
CREATE DATABASE [$(DatabaseName)] COLLATE Ukrainian_CI_AS
GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET ANSI_NULLS ON,
                ANSI_PADDING ON,
                ANSI_WARNINGS ON,
                ARITHABORT ON,
                CONCAT_NULL_YIELDS_NULL ON,
                NUMERIC_ROUNDABORT OFF,
                QUOTED_IDENTIFIER ON,
                ANSI_NULL_DEFAULT ON,
                CURSOR_DEFAULT LOCAL,
                RECOVERY FULL,
                CURSOR_CLOSE_ON_COMMIT OFF,
                AUTO_CREATE_STATISTICS ON,
                AUTO_SHRINK OFF,
                AUTO_UPDATE_STATISTICS ON,
                RECURSIVE_TRIGGERS OFF 
            WITH ROLLBACK IMMEDIATE;
        ALTER DATABASE [$(DatabaseName)]
            SET AUTO_CLOSE OFF 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET ALLOW_SNAPSHOT_ISOLATION OFF;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET READ_COMMITTED_SNAPSHOT OFF 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET AUTO_UPDATE_STATISTICS_ASYNC OFF,
                PAGE_VERIFY NONE,
                DATE_CORRELATION_OPTIMIZATION OFF,
                DISABLE_BROKER,
                PARAMETERIZATION SIMPLE,
                SUPPLEMENTAL_LOGGING OFF 
            WITH ROLLBACK IMMEDIATE;
    END


GO
IF IS_SRVROLEMEMBER(N'sysadmin') = 1
    BEGIN
        IF EXISTS (SELECT 1
                   FROM   [master].[dbo].[sysdatabases]
                   WHERE  [name] = N'$(DatabaseName)')
            BEGIN
                EXECUTE sp_executesql N'ALTER DATABASE [$(DatabaseName)]
    SET TRUSTWORTHY OFF,
        DB_CHAINING OFF 
    WITH ROLLBACK IMMEDIATE';
            END
    END
ELSE
    BEGIN
        PRINT N'The database settings cannot be modified. You must be a SysAdmin to apply these settings.';
    END


GO
IF IS_SRVROLEMEMBER(N'sysadmin') = 1
    BEGIN
        IF EXISTS (SELECT 1
                   FROM   [master].[dbo].[sysdatabases]
                   WHERE  [name] = N'$(DatabaseName)')
            BEGIN
                EXECUTE sp_executesql N'ALTER DATABASE [$(DatabaseName)]
    SET HONOR_BROKER_PRIORITY OFF 
    WITH ROLLBACK IMMEDIATE';
            END
    END
ELSE
    BEGIN
        PRINT N'The database settings cannot be modified. You must be a SysAdmin to apply these settings.';
    END


GO
ALTER DATABASE [$(DatabaseName)]
    SET TARGET_RECOVERY_TIME = 0 SECONDS 
    WITH ROLLBACK IMMEDIATE;


GO
IF EXISTS (SELECT 1
           FROM   [master].[dbo].[sysdatabases]
           WHERE  [name] = N'$(DatabaseName)')
    BEGIN
        ALTER DATABASE [$(DatabaseName)]
            SET FILESTREAM(NON_TRANSACTED_ACCESS = OFF),
                CONTAINMENT = NONE 
            WITH ROLLBACK IMMEDIATE;
    END


GO
USE [$(DatabaseName)];


GO
IF fulltextserviceproperty(N'IsFulltextInstalled') = 1
    EXECUTE sp_fulltext_database 'enable';


GO
PRINT N'Creating [test]...';


GO
CREATE SCHEMA [test]
    AUTHORIZATION [dbo];


GO
PRINT N'Creating [utils]...';


GO
CREATE SCHEMA [utils]
    AUTHORIZATION [dbo];


GO
PRINT N'Creating [stage]...';


GO
CREATE SCHEMA [stage]
    AUTHORIZATION [dbo];


GO
PRINT N'Creating [rep]...';


GO
CREATE SCHEMA [rep]
    AUTHORIZATION [dbo];


GO
PRINT N'Creating [etl]...';


GO
CREATE SCHEMA [etl]
    AUTHORIZATION [dbo];


GO
PRINT N'Creating [dbo].[Users]...';


GO
CREATE TABLE [dbo].[Users] (
    [Id]       INT            IDENTITY (1, 1) NOT NULL,
    [UserName] NVARCHAR (128) NOT NULL,
    [Mail]     NVARCHAR (128) NOT NULL,
    PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating [dbo].[UserAffiliates]...';


GO
CREATE TABLE [dbo].[UserAffiliates] (
    [UserId]      INT NOT NULL,
    [AffiliateId] INT NOT NULL
);


GO
PRINT N'Creating [dbo].[Settings]...';


GO
CREATE TABLE [dbo].[Settings] (
    [SettingKey]   INT           NOT NULL,
    [SettingName]  VARCHAR (255) NOT NULL,
    [SettingValue] VARCHAR (255) NULL
);


GO
PRINT N'Creating [dbo].[FactCampaign]...';


GO
CREATE TABLE [dbo].[FactCampaign] (
    [DateKey]            INT             NOT NULL,
    [TimeZoneKey]        INT             NOT NULL,
    [DLS]                SMALLINT        NOT NULL,
    [RevenueSourceKey]   INT             NOT NULL,
    [SpendSourceKey]     INT             NOT NULL,
    [BusinessAccountKey] INT             NOT NULL,
    [AdAccountKey]       INT             NOT NULL,
    [ProductKey]         INT             NOT NULL,
    [AffiliateKey]       INT             NOT NULL,
    [CampaignKey]        INT             NOT NULL,
    [LinkId]             NVARCHAR (255)  NULL,
    [Revenue]            DECIMAL (12, 2) NULL,
    [Spend]              DECIMAL (12, 2) NULL,
    [Profit]             DECIMAL (12, 2) NULL
);


GO
PRINT N'Creating [dbo].[DimTimeZone]...';


GO
CREATE TABLE [dbo].[DimTimeZone] (
    [TimeZoneKey]    INT           NOT NULL,
    [TimeZoneBK]     INT           NOT NULL,
    [TimeZoneName]   NVARCHAR (64) NOT NULL,
    [TimeZoneOffset] INT           NOT NULL
);


GO
PRINT N'Creating [dbo].[DimSource]...';


GO
CREATE TABLE [dbo].[DimSource] (
    [SourceKey]  INT           NOT NULL,
    [SourceName] NVARCHAR (64) NULL,
    PRIMARY KEY CLUSTERED ([SourceKey] ASC)
);


GO
PRINT N'Creating [dbo].[DimProduct]...';


GO
CREATE TABLE [dbo].[DimProduct] (
    [ProductKey]  INT           NOT NULL,
    [ProductName] NVARCHAR (64) NOT NULL,
    PRIMARY KEY CLUSTERED ([ProductKey] ASC)
);


GO
PRINT N'Creating [dbo].[DimDate]...';


GO
CREATE TABLE [dbo].[DimDate] (
    [DateKey]       INT                NOT NULL,
    [FullDate]      DATETIMEOFFSET (7) NULL,
    [DayOfWeek]     TINYINT            NULL,
    [DayNumInMonth] TINYINT            NULL,
    [DayName]       VARCHAR (9)        NULL,
    [DayAbbrev]     CHAR (3)           NULL,
    [WeekdayFlag]   CHAR (1)           NULL,
    [WeekNumInYear] TINYINT            NULL,
    [Month]         TINYINT            NULL,
    [MonthName]     VARCHAR (9)        NULL,
    [MonthAbbrev]   CHAR (3)           NULL,
    [Quarter]       TINYINT            NULL,
    [Year]          SMALLINT           NULL,
    [Yearmo]        INT                NULL,
    CONSTRAINT [PK_DimDate] PRIMARY KEY CLUSTERED ([DateKey] ASC)
);


GO
PRINT N'Creating [dbo].[DimCampaign]...';


GO
CREATE TABLE [dbo].[DimCampaign] (
    [CampaignKey]  INT            NOT NULL,
    [CampaignBK]   NVARCHAR (25)  NOT NULL,
    [CampaignName] NVARCHAR (255) NOT NULL,
    PRIMARY KEY CLUSTERED ([CampaignKey] ASC)
);


GO
PRINT N'Creating [dbo].[DimBusinessAccount]...';


GO
CREATE TABLE [dbo].[DimBusinessAccount] (
    [BusinessAccountKey]  INT            NOT NULL,
    [BusinessAccountBK]   NVARCHAR (25)  NOT NULL,
    [BusinessAccountName] NVARCHAR (255) NOT NULL,
    PRIMARY KEY CLUSTERED ([BusinessAccountKey] ASC)
);


GO
PRINT N'Creating [dbo].[DimAffiliate]...';


GO
CREATE TABLE [dbo].[DimAffiliate] (
    [AffiliateKey]  INT           NOT NULL,
    [AffiliateBK]   INT           NOT NULL,
    [AffiliateName] NVARCHAR (64) NOT NULL,
    PRIMARY KEY CLUSTERED ([AffiliateKey] ASC)
);


GO
PRINT N'Creating [dbo].[DimAdAccount]...';


GO
CREATE TABLE [dbo].[DimAdAccount] (
    [AdAccountKey]  INT            NOT NULL,
    [AdAccountBK]   NVARCHAR (25)  NOT NULL,
    [AdAccountName] NVARCHAR (255) NOT NULL,
    PRIMARY KEY CLUSTERED ([AdAccountKey] ASC)
);


GO
PRINT N'Creating [stage].[FBObjectStorySpec]...';


GO
CREATE TABLE [stage].[FBObjectStorySpec] (
    [campaign_id]   NVARCHAR (25)  NULL,
    [ad_id]         NVARCHAR (25)  NULL,
    [adcreative_id] NVARCHAR (25)  NULL,
    [link]          NVARCHAR (500) NULL
);


GO
PRINT N'Creating [stage].[FBInsights]...';


GO
CREATE TABLE [stage].[FBInsights] (
    [account_id]                 NVARCHAR (25)   NULL,
    [ad_id]                      NVARCHAR (25)   NOT NULL,
    [spend]                      DECIMAL (18, 2) NULL,
    [date_start]                 DATE            NULL,
    [hs_by_advertiser_time_zone] VARCHAR (20)    NULL
);


GO
PRINT N'Creating [stage].[FBCampaigns]...';


GO
CREATE TABLE [stage].[FBCampaigns] (
    [account_id]    NVARCHAR (25)  NULL,
    [campaign_id]   NVARCHAR (25)  NULL,
    [campaign_name] NVARCHAR (255) NULL
);


GO
PRINT N'Creating [stage].[FBCampaignInsightsUTC]...';


GO
CREATE TABLE [stage].[FBCampaignInsightsUTC] (
    [campaign_id]      NVARCHAR (25)      NULL,
    [fb_id]            NVARCHAR (255)     NULL,
    [insight_utc_date] DATETIMEOFFSET (7) NULL,
    [spend]            DECIMAL (12, 2)    NULL,
    [dls]              SMALLINT           NOT NULL
);


GO
PRINT N'Creating [stage].[FBBusinessAccounts]...';


GO
CREATE TABLE [stage].[FBBusinessAccounts] (
    [id]   NVARCHAR (25)  NOT NULL,
    [name] NVARCHAR (255) NOT NULL
);


GO
PRINT N'Creating [stage].[FBAds]...';


GO
CREATE TABLE [stage].[FBAds] (
    [account_id]    NVARCHAR (25)  NULL,
    [campaign_id]   NVARCHAR (25)  NULL,
    [campaign_name] NVARCHAR (255) NULL,
    [id]            NVARCHAR (25)  NULL,
    [name]          NVARCHAR (255) NULL
);


GO
PRINT N'Creating [stage].[FBAdaccounts]...';


GO
CREATE TABLE [stage].[FBAdaccounts] (
    [id]                        NVARCHAR (25)  NULL,
    [account_id]                NVARCHAR (25)  NULL,
    [business_id]               NVARCHAR (25)  NULL,
    [name]                      NVARCHAR (255) NULL,
    [timezone_id]               BIGINT         NULL,
    [timezone_name]             NVARCHAR (100) NULL,
    [timezone_offset_hours_utc] BIGINT         NULL
);


GO
PRINT N'Creating [stage].[CakeConversions]...';


GO
CREATE TABLE [stage].[CakeConversions] (
    [advertiser_id]   INT             NULL,
    [affiliate_id]    INT             NULL,
    [affiliate_name]  NVARCHAR (64)   NULL,
    [campaign_id]     INT             NULL,
    [conversion_date] DATETIME        NULL,
    [conversion_id]   NVARCHAR (64)   NULL,
    [conversion_type] NVARCHAR (64)   NULL,
    [creative_id]     INT             NULL,
    [offer_id]        INT             NULL,
    [price_paid]      DECIMAL (18, 2) NULL,
    [price_received]  DECIMAL (18, 2) NULL,
    [returned]        BIT             NULL,
    [subid_1]         NVARCHAR (255)  NULL,
    [subid_2]         NVARCHAR (255)  NULL,
    [subid_3]         NVARCHAR (255)  NULL,
    [subid_4]         NVARCHAR (255)  NULL,
    [subid_5]         NVARCHAR (255)  NULL,
    [transaction_id]  NVARCHAR (64)   NULL,
    [test]            BIT             NULL
);


GO
PRINT N'Creating [stage].[CakeClicks]...';


GO
CREATE TABLE [stage].[CakeClicks] (
    [affiliate_id] INT            NULL,
    [campaign_id]  INT            NULL,
    [click_date]   DATETIME       NULL,
    [subid_3]      NVARCHAR (255) NULL
);


GO
PRINT N'Creating [stage].[CakeCampaignInsightsUTC]...';


GO
CREATE TABLE [stage].[CakeCampaignInsightsUTC] (
    [affiliate_id]     INT                NULL,
    [campaign_id]      INT                NULL,
    [fb_id]            NVARCHAR (255)     NULL,
    [insight_utc_date] DATETIMEOFFSET (7) NULL,
    [revenue]          DECIMAL (12, 2)    NULL,
    [dls]              SMALLINT           NOT NULL
);


GO
PRINT N'Creating [stage].[StageErrorLog]...';


GO
CREATE TABLE [stage].[StageErrorLog] (
    [Id]          INT             IDENTITY (1, 1) NOT NULL,
    [Date]        DATETIME        NULL,
    [PackageName] NVARCHAR (255)  NULL,
    [TaskName]    NVARCHAR (255)  NULL,
    [SourceName]  NVARCHAR (50)   NULL,
    [Message]     NVARCHAR (1000) NULL,
    PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating unnamed constraint on [dbo].[FactCampaign]...';


GO
ALTER TABLE [dbo].[FactCampaign]
    ADD DEFAULT ((0)) FOR [DLS];


GO
PRINT N'Creating unnamed constraint on [dbo].[FactCampaign]...';


GO
ALTER TABLE [dbo].[FactCampaign]
    ADD DEFAULT ((-1)) FOR [BusinessAccountKey];


GO
PRINT N'Creating unnamed constraint on [dbo].[FactCampaign]...';


GO
ALTER TABLE [dbo].[FactCampaign]
    ADD DEFAULT ((-1)) FOR [AdAccountKey];


GO
PRINT N'Creating unnamed constraint on [dbo].[FactCampaign]...';


GO
ALTER TABLE [dbo].[FactCampaign]
    ADD DEFAULT ((-1)) FOR [AffiliateKey];


GO
PRINT N'Creating unnamed constraint on [stage].[FBCampaignInsightsUTC]...';


GO
ALTER TABLE [stage].[FBCampaignInsightsUTC]
    ADD DEFAULT ((0)) FOR [dls];


GO
PRINT N'Creating unnamed constraint on [stage].[CakeCampaignInsightsUTC]...';


GO
ALTER TABLE [stage].[CakeCampaignInsightsUTC]
    ADD DEFAULT ((0)) FOR [dls];


GO
PRINT N'Creating [dbo].[GetLastDateFromDimDate]...';


GO
CREATE function [dbo].[GetLastDateFromDimDate]()
returns smalldatetime
as
begin
	declare @lastDate smalldatetime
	select @lastDate = max(FullDate) from dbo.DimDate;

	if @lastDate is null
		select @lastDate = SettingValue from dbo.Settings where SettingName = 'StartDate';

	return @lastDate
end
GO
PRINT N'Creating [dbo].[GetFirstDateOfYear]...';


GO
create function dbo.GetFirstDateOfYear(@dt date)
returns date
as
begin
	return(select datefromparts(year(@dt), 1, 1));
end
GO
PRINT N'Creating [dbo].[GetUSDaylightSaving]...';


GO
CREATE FUNCTION dbo.GetUSDaylightSaving(@dt date)
RETURNS INT
AS
BEGIN

	--SET DATEFIRST 7

	DECLARE
		@year INT,
		@StartOfMarch DATETIME ,
		@StartOfNovember DATETIME ,
		@DstStart DATETIME ,
		@DstEnd DATETIME

	SET @year = year(@dt)
	SET @StartOfMarch = DATEADD(MONTH, 2, DATEADD(YEAR, @year - 1900, 0))
	SET @StartOfNovember = DATEADD(MONTH, 10, DATEADD(YEAR, @year - 1900, 0));
	SET @DstStart = DATEADD(HOUR, 2,
							DATEADD(day,
									( ( 15 - DATEPART(dw, @StartOfMarch) ) % 7 )
									+ 7, @StartOfMarch))
	SET @DstEnd = DATEADD(HOUR, 2,
						  DATEADD(day,
								  ( ( 8 - DATEPART(dw, @StartOfNovember) ) % 7 ),
								  @StartOfNovember))

	--select @DstStart, @DstEnd
	RETURN(SELECT CASE WHEN @dt BETWEEN @DstStart AND @DstEnd THEN -1 ELSE 0 END)

END
GO
PRINT N'Creating [dbo].[GetLinkParameterValue]...';


GO
CREATE FUNCTION [dbo].[GetLinkParameterValue](@Link nvarchar(255), @ParameterName nvarchar(32))
RETURNS NVARCHAR(64)
AS
BEGIN

	SET @ParameterName = @ParameterName + '='

	IF CHARINDEX(@ParameterName, @Link, 0) <= 0 
		RETURN NULL

	SET @link = SUBSTRING(@Link, CHARINDEX(@ParameterName, @Link, 0) + LEN(@ParameterName), LEN(@Link)) 
	RETURN RTRIM(SUBSTRING(@Link, 0, CASE WHEN CHARINDEX('&', @Link, 0) > 0 THEN CHARINDEX('&', @Link, 0) ELSE LEN(@Link) + 1 END))


END
GO
PRINT N'Creating [dbo].[GetDateMonthRange]...';


GO
CREATE FUNCTION [dbo].[GetDateMonthRange]
(	
	@StartDate datetime,
	@EndDate datetime
)
/* Test Comment 14 */
RETURNS TABLE 
AS
RETURN 
(
	WITH lst AS (
		SELECT @StartDate AS dt
		UNION ALL
		SELECT DATEADD(MONTH, 1, dt) dt
		  FROM lst s 
		 WHERE DATEADD(MONTH, 1, dt) <= @EndDate )
	SELECT * FROM lst 
)
GO
PRINT N'Creating [utils].[CSVToTable]...';


GO
CREATE FUNCTION [utils].[CSVToTable] (@InStr varchar(max), @sep char(1))
RETURNS @TempTab TABLE
   (value varchar(max) NOT NULL)
AS
BEGIN
    ;-- Ensure input ends with comma
	SET @InStr = replace(@InStr + @sep, @sep+@sep, @sep)
	DECLARE 
		@SP int, 
		@len int, 
		@spos int, @fpos int
	DECLARE @value1 varchar(1000)

	SET @len = LEN(@InStr);
	SET @spos = 1; SET @fpos = 1;
	WHILE @fpos <= @len BEGIN
		IF SUBSTRING(@InStr, @fpos, 1) = @sep BEGIN	
			INSERT INTO @TempTab(value) VALUES (ltrim(rtrim(SUBSTRING(@InStr, @spos, @fpos - @spos))));

			SET @fpos = @fpos + 1; 
			SET @spos = @fpos;
		END ELSE 
			SET @fpos = @fpos + 1;
	END;
	RETURN
END
GO
PRINT N'Creating [utils].[GetDoubleCampaignsId]...';


GO
CREATE PROCEDURE [utils].[GetDoubleCampaignsId]
AS
BEGIN
	
IF OBJECT_ID('tempdb..#ss') IS NOT NULL
	DROP TABLE #ss


SELECT DISTINCT
account_id = r.account_id
,account_name = r.name
,campaign_name = r.campaign_name
,campaign_id = r.campaign_id
,fb_id = SUBSTRING(r.fb_id, 0, CASE WHEN CHARINDEX('&', r.fb_id, 0) > 0 THEN CHARINDEX('&', r.fb_id, 0) ELSE LEN(r.fb_id) + 1  END)
		INTO #ss
FROM (
		SELECT a.account_id, a.name, campaign_id = c.campaign_id, c.campaign_name
				,fb_id = SUBSTRING(os.link, CHARINDEX('&c2=', os.link, 0) + 4, LEN(os.link)) 
							
		FROM [stage].[FBAdaccounts] a
			INNER JOIN [stage].[FBCampaigns] c ON c.account_id = a.account_id
			INNER JOIN [stage].[FBAds] ad ON ad.campaign_id = c.campaign_id
			INNER JOIN [stage].[FBObjectStorySpec] os ON os.ad_id = ad.id
	)r


SELECT account_name, campaign_name, campaign_id, fb_id FROM #ss 
WHERE campaign_id IN (SELECT campaign_id FROM #ss group by campaign_id having count(*) > 1)
AND fb_id like '%fb-%'
ORDER BY campaign_name


END
GO
PRINT N'Creating [utils].[GetDaysRange]...';


GO
CREATE PROCEDURE [utils].[GetDaysRange]
	@DateFrom DateTime,
	@DateTo DateTime
AS
BEGIN
	
	IF @DateFrom > @DateTo RETURN;

	WITH lst AS (
		SELECT cast(cast(@DateFrom as date) as datetime) AS dt
		UNION ALL
		SELECT DATEADD(dd, 1, dt) dt
		  FROM lst s 
		 WHERE DATEADD(dd, 1, dt) < @DateTo )

	SELECT DateFrom, DateTo
	FROM (SELECT dt as DateFrom, LEAD(dt) OVER(order by dt) as DateTo
			FROM (SELECT CONVERT(VARCHAR(20), CAST(@DateFrom AS DateTime), 120) as dt
			UNION
			SELECT DISTINCT CONVERT(VARCHAR(20), dt, 120) FROM lst  WHERE dt > cast(@DateFrom as date) AND dt <= cast(@DateTo as date)
			UNION
			SELECT CONVERT(VARCHAR(20), CAST(@DateTo AS DateTime), 120) as dt) r) res
	WHERE res.DateTo IS NOT NULL
	OPTION (maxrecursion 0)


END
GO
PRINT N'Creating [utils].[GetAdDetails]...';


GO
CREATE PROCEDURE [utils].[GetAdDetails]
	@campaignid nvarchar(25),
	@FB_ID nvarchar(50)
AS
BEGIN
	
	SELECT c.campaign_name, a.name, os.link
	FROM [stage].[FBAds] a
		INNER JOIN [stage].[FBObjectStorySpec] os ON a.id = os.ad_id
		INNER JOIN [stage].[FBCampaigns] c ON a.campaign_id = c.campaign_id
	WHERE a.campaign_id = @campaignid
	AND os.link like '%' + @FB_ID + '%'

END
GO
PRINT N'Creating [utils].[GetDoubleFbIds]...';


GO
CREATE PROCEDURE [utils].[GetDoubleFbIds]
AS
BEGIN
	
IF OBJECT_ID('tempdb..#ss') IS NOT NULL
	DROP TABLE #ss


SELECT DISTINCT
account_id = r.account_id
,account_name = r.name
,campaign_name = r.campaign_name
,campaign_id = r.campaign_id
,fb_id = SUBSTRING(r.fb_id, 0, CASE WHEN CHARINDEX('&', r.fb_id, 0) > 0 THEN CHARINDEX('&', r.fb_id, 0) ELSE LEN(r.fb_id) + 1  END)
		INTO #ss
FROM (
		SELECT a.account_id, a.name, campaign_id = c.campaign_id, c.campaign_name
				,fb_id = SUBSTRING(os.link, CHARINDEX('&c2=', os.link, 0) + 4, LEN(os.link)) 
							
		FROM [stage].[FBAdaccounts] a
			INNER JOIN [stage].[FBCampaigns] c ON c.account_id = a.account_id
			INNER JOIN [stage].[FBAds] ad ON ad.campaign_id = c.campaign_id
			INNER JOIN [stage].[FBObjectStorySpec] os ON os.ad_id = ad.id
	)r


SELECT account_name, campaign_name, campaign_id, fb_id from 
(
	SELECT * FROM #ss 
	WHERE fb_id IN (SELECT fb_id FROM #ss group by fb_id having count(*) > 1)
) r
where  (r.fb_id like '%fb-%' OR r.fb_id like '%alpha%')
and r.fb_id in (select distinct subid_3 from [stage].[CakeClicks])
order by fb_id, campaign_Name

END
GO
PRINT N'Creating [stage].[Load_FBCampaignInsightsUTC]...';


GO
CREATE PROCEDURE [stage].[Load_FBCampaignInsightsUTC]
	@InightsDate Date
AS
BEGIN
	SET DATEFIRST 7

	DECLARE @USDLS smallint
	SET @USDLS = [dbo].[GetUSDaylightSaving](@InightsDate)


	MERGE INTO [stage].[FBCampaignInsightsUTC] fu
	USING(
			SELECT campaign_id = res.campaign_id
						,fb_id = res.fb_id
						,insight_utc_date = res.insight_utc_date
						,spend = SUM(res.spend)
						,dls = @USDLS
				FROM (
						SELECT 
								campaign_id = r.campaign_id
								,fb_id = r.fb_id
								,insight_utc_date = SWITCHOFFSET(r.insight_utc_date, '+00:00') 
								,spend = r.spend
						FROM (
								SELECT campaign_id = c.campaign_id
										,fb_id = ISNULL([dbo].[GetLinkParameterValue](os.link, 'c2'), [dbo].[GetLinkParameterValue](os.link, 's3'))
										,insight_utc_date = TODATETIMEOFFSET(cast(cast(i.date_start as varchar(10)) + ' ' + CAST(i.[hs_by_advertiser_time_zone] as varchar(8)) as DateTime),  60 * (a.timezone_offset_hours_utc + @USDLS))
										,spend = SUM(ISNULL(i.spend, 0))
								FROM [stage].[FBAdaccounts] a
									INNER JOIN [stage].[FBCampaigns] c ON c.account_id = a.account_id
									INNER JOIN [stage].[FBAds] ad ON ad.campaign_id = c.campaign_id
									INNER JOIN [stage].[FBInsights] i ON i.ad_id = ad.id AND i.[date_start] = @InightsDate
									INNER JOIN [stage].[FBObjectStorySpec] os ON os.ad_id = ad.id
								GROUP BY a.business_id, a.account_id, c.campaign_id, i.date_start, i.hs_by_advertiser_time_zone, os.link, a.timezone_id, a.timezone_offset_hours_utc
								UNION ALL 
								SELECT campaign_id = e.campaign_id
										,fb_id = e.fb_id 
										,insight_utc_date = TODATETIMEOFFSET(CAST(cast(@InightsDate as varchar(10)) + ' 12:00:00' AS DATETIME),  60 * (e.timezone_offset_hours_utc + @USDLS))
										,spend = 0
								FROM (SELECT c.campaign_id,
												ISNULL([dbo].[GetLinkParameterValue](os.link, 'c2'), [dbo].[GetLinkParameterValue](os.link, 's3')) as fb_id,
												i.date_start,
												a.[timezone_id], 
												a.timezone_offset_hours_utc
										FROM [stage].[FBAdaccounts] a
											INNER JOIN [stage].[FBCampaigns] c ON c.account_id = a.account_id
											INNER JOIN [stage].[FBAds] ad ON ad.campaign_id = c.campaign_id
											LEFT JOIN [stage].[FBInsights] i ON i.ad_id = ad.id AND i.[date_start] = @InightsDate
											INNER JOIN [stage].[FBObjectStorySpec] os ON os.ad_id = ad.id
										GROUP BY a.business_id, a.account_id, c.campaign_id, i.date_start, i.hs_by_advertiser_time_zone, os.link, a.timezone_id, a.timezone_offset_hours_utc) e
								GROUP BY e.campaign_id, e.fb_id, e.[timezone_id], e.timezone_offset_hours_utc
								HAVING COUNT(*) = 1 AND MIN(e.date_start) IS NULL) r) res
				WHERE res.fb_id IS NOT NULL
				GROUP BY res.campaign_id, res.fb_id, res.insight_utc_date
		)n ON (n.campaign_id = fu.campaign_id AND n.fb_id = fu.fb_id AND n.insight_utc_date = fu.insight_utc_date)
	WHEN MATCHED THEN
		UPDATE SET
			spend = n.spend
	WHEN NOT MATCHED THEN
		INSERT
		(
			[campaign_id],
			[fb_id],
			[insight_utc_date],
			[spend],
			[dls]
		)
		VALUES
		(
			n.[campaign_id],
			n.[fb_id],
			n.[insight_utc_date],
			n.[spend],
			n.[dls]
		);
END
GO
PRINT N'Creating [stage].[Load_CakeCampaignInsightsUTC]...';


GO
CREATE PROCEDURE [stage].[Load_CakeCampaignInsightsUTC]
	@InightsDate Date
AS
BEGIN
	SET DATEFIRST 7
	/* Test comment 6 */
	DECLARE @USDLS smallint, @cake_timezone_offset_hours_utc int
	
	SELECT @cake_timezone_offset_hours_utc = SettingValue FROM [dbo].[Settings] WHERE SettingName = 'CAKETimeZoneOffsetHoursUTC'
	
	SET @USDLS = [dbo].[GetUSDaylightSaving](@InightsDate)
	SET @cake_timezone_offset_hours_utc = 60 * (@cake_timezone_offset_hours_utc + @USDLS)

	MERGE INTO [stage].[CakeCampaignInsightsUTC] cu
	USING(
			SELECT 
				ISNULL(cl.affiliate_id, cc.affiliate_id) as affiliate_id, 
				ISNULL(cl.campaign_id, cc.campaign_id) as campaign_id, 
				ISNULL(cl.subid_3, cc.subid_3) as fb_id, 
				SWITCHOFFSET(TODATETIMEOFFSET(DATEADD(HOUR, ISNULL(cc.conversion_hour, 0), CAST(ISNULL(cl.click_date, cc.conversion_date) as DateTime)), @cake_timezone_offset_hours_utc), '+00:00')  as insight_utc_date,
				ISNULL(cc.Revenue, 0) AS revenue,
				dls = @USDLS
			FROM (SELECT DISTINCT affiliate_id, campaign_id, CAST(click_date AS DATE) AS click_date, subid_3 FROM [stage].[CakeClicks] WHERE campaign_id > 0 AND CAST(click_date AS DATE) = @InightsDate) cl
				FULL JOIN (
							SELECT cc.affiliate_id, cc.campaign_id, RTRIM(LTRIM(cc.subid_3)) as subid_3, CAST(cc.conversion_date AS DATE) as conversion_date, 
														DATEPART(HOUR,cc.conversion_date) as conversion_hour, 
														cc.price_paid as price,
														cc.price_paid * count(*) as Revenue
							FROM [stage].[CakeConversions] cc
							WHERE CAST(cc.conversion_date as date) = @InightsDate
							GROUP BY cc.affiliate_id, cc.campaign_id, CAST(cc.conversion_date AS DATE), DATEPART(HOUR,cc.conversion_date), cc.[price_paid], cc.subid_3) cc 
			ON cc.subid_3 = cl.subid_3 AND cc.campaign_id = cl.campaign_id AND cc.conversion_date = cl.click_date
		)n ON (n.affiliate_id = cu.affiliate_id AND n.campaign_id = cu.campaign_id AND n.fb_id = cu.fb_id AND n.insight_utc_date = cu.insight_utc_date)
	WHEN MATCHED THEN
		UPDATE SET
			revenue = n.revenue
	WHEN NOT MATCHED THEN
		INSERT
		(
			[affiliate_id],
			[campaign_id],
			[fb_id],
			[insight_utc_date],
			[revenue],
			[dls]
		)
		VALUES
		(
			n.[affiliate_id],
			n.[campaign_id],
			n.[fb_id],
			n.[insight_utc_date],
			n.[revenue],
			n.[dls]
		);
END
GO
PRINT N'Creating [stage].[CleanAdAccountData]...';


GO
CREATE PROCEDURE [stage].[CleanAdAccountData]
@AdAccountId NVARCHAR(25)
AS
BEGIN
	
	DELETE os
	FROM [stage].[FBCampaigns] c
		INNER JOIN [stage].[FBAds] a ON a.campaign_id = c.campaign_id
		INNER JOIN [stage].[FBObjectStorySpec] os ON os.ad_id = a.id
	WHERE c.account_id = @AdAccountId

	DELETE a
	FROM [stage].[FBCampaigns] c
		INNER JOIN [stage].[FBAds] a ON a.campaign_id = c.campaign_id
	WHERE c.account_id = @AdAccountId

	DELETE c
	FROM [stage].[FBCampaigns] c WHERE c.account_id = @AdAccountId
	
END
GO
PRINT N'Creating [stage].[CleanStage]...';


GO
CREATE PROCEDURE [stage].[CleanStage]
AS
BEGIN
	
	TRUNCATE TABLE [stage].[FBAdaccounts];
	TRUNCATE TABLE [stage].[FBAds];
	TRUNCATE TABLE [stage].[FBObjectStorySpec];
	TRUNCATE TABLE [stage].[FBInsights];
	TRUNCATE TABLE [stage].[CakeConversions];
	TRUNCATE TABLE [stage].[SHLCampaignSummary];
	TRUNCATE TABLE [stage].[SHLConversions];
	TRUNCATE TABLE [stage].[A4DCampaignSummary];
	TRUNCATE TABLE [stage].[A4DConversions];
	
END
GO
PRINT N'Creating [rep].[param_TimeZone]...';


GO
CREATE PROCEDURE [rep].[param_TimeZone]
AS
BEGIN
	SET NOCOUNT ON;
	
	SELECT r.TimeZoneKey, r.TimeZoneName
	FROM (
		SELECT TimeZoneKey = 0, TimeZoneName = 'AdAccount Time Zone' , Ord = 0
		UNION ALL
		SELECT dtz.TimeZoneKey, dtz.TimeZoneName, Ord = 1
		FROM [dbo].[DimTimeZone] dtz
		WHERE dtz.TimeZoneKey > 0) r
	ORDER BY r.Ord, r.TimeZoneName

END
GO
PRINT N'Creating [rep].[param_Campaign]...';


GO
CREATE PROCEDURE [rep].[param_Campaign]
	@AdAccount nvarchar(max) = NULL
AS
BEGIN
	SET NOCOUNT ON;

	SELECT DISTINCT dc.CampaignKey, dc.CampaignName
	FROM [dbo].[FactCampaign] fc
		INNER JOIN [dbo].[DimCampaign] dc ON dc.CampaignKey = fc.CampaignKey
	WHERE (@AdAccount IS NULL OR fc.AdAccountKey IN (SELECT * FROM [utils].[CSVToTable](@AdAccount, ',')))
	ORDER BY dc.CampaignName

END
GO
PRINT N'Creating [rep].[param_BusinessAccount]...';


GO
CREATE PROCEDURE [rep].[param_BusinessAccount]
AS
BEGIN
	SET NOCOUNT ON;

	SELECT [BusinessAccountKey], [BusinessAccountName] 
	FROM [dbo].[DimBusinessAccount] 
	--WHERE [BusinessAccountKey] > -1
	ORDER BY [BusinessAccountName]
END
GO
PRINT N'Creating [rep].[param_Affiliate]...';


GO
CREATE PROCEDURE [rep].[param_Affiliate]
	@UserId NVARCHAR(128)
AS
BEGIN
	SET NOCOUNT ON;

	SELECT [AffiliateKey], [AffiliateName] 
	FROM  [dbo].[DimAffiliate] da
		INNER JOIN [dbo].[UserAffiliates] ua ON ua.AffiliateId = da.AffiliateKey
		INNER JOIN [dbo].[Users] u ON ua.UserId = u.Id
	WHERE u.UserName = @UserId
		--AND [AffiliateKey] > -1
	ORDER BY [AffiliateName]
END
GO
PRINT N'Creating [rep].[param_AdAccount]...';


GO

CREATE PROCEDURE [rep].[param_AdAccount]
	@BusinessAccount nvarchar(max) = NULL
AS
BEGIN
	SET NOCOUNT ON;

	SELECT DISTINCT daa.AdAccountKey, daa.AdAccountName
	FROM [dbo].[FactCampaign] fc
		INNER JOIN [dbo].[DimAdAccount] daa ON daa.[AdAccountKey] = fc.AdAccountKey
	WHERE (@BusinessAccount IS NULL OR fc.[BusinessAccountKey] IN (SELECT * FROM [utils].[CSVToTable](@BusinessAccount, ',')))
	ORDER BY daa.AdAccountName

END
GO
PRINT N'Creating [rep].[AlphaTeamHourlyDetailsReport]...';


GO
CREATE PROCEDURE [rep].[AlphaTeamHourlyDetailsReport]
	@Date date,
	@TimeZoneKey int,
	@BusinessAccountKey int,
	@AdAccountKey int,
	@AffiliateKey int,
	@CampaignKey int,
	@ROI nvarchar(20)
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE 
		@TimeZoneOffset int,
		@TimeZoneOffsetStr nvarchar(20) = 'dtz.TimeZoneOffset',
		@SQL nvarchar(max),
		@params nvarchar(max)


	SET @params = '
			 @BusinessAccountKey int = NULL
			,@AdAccountKey int = NULL
			,@AffiliateKey int = NULL
			,@CampaignKey int = NULL
			,@TimeZoneOffset int = 0
	        ,@Date date = NULL
	     '
	
	IF @TimeZoneKey > 0
	BEGIN
		SELECT @TimeZoneOffset = TimeZoneOffset FROM [dbo].[DimTimeZone] WHERE TimeZoneKey = @TimeZoneKey
		SET @TimeZoneOffsetStr = '@TimeZoneOffset'
	END

	
	SET @SQL = '
	SELECT 
		 [Date] = h.[Date]
		,[Hour] = DATEPART(HOUR, h.[Date])
		,[BusinessAccount] = dba.BusinessAccountName
		,[AdAccount] = da.AdAccountName
		,[Affiliate] = daf.AffiliateName
		,[Campaign] = dc.CampaignName
		,[Source] = ds.SourceName
		,[LinkId] = h.LinkId
		,[Rev] = h.Revenue
		,[MaxRev] = MAX(h.Revenue) OVER()
		,[Spend] = h.Spend
		,[MaxSpend] = MAX(h.Spend) OVER()
		,[Profit] = h.Profit
		,[ROI] = CASE WHEN h.Spend = 0 THEN 0 ELSE h.Profit / h.Spend END
			FROM (
				SELECT 
					 [Date] = CAST(SWITCHOFFSET(dd.FullDate, 60 * (' + @TimeZoneOffsetStr + ' + fc.DLS)) AS DATETIME)
					,fc.AffiliateKey
					,fc.BusinessAccountKey
					,fc.AdAccountKey
					,fc.CampaignKey
					,fc.SpendSourceKey
					,fc.LinkId
					,fc.Revenue
					,fc.Spend
					,fc.Profit
				FROM [dbo].[FactCampaign] fc
					INNER JOIN [dbo].[DimDate] dd ON fc.DateKey = dd.DateKey
					INNER JOIN [dbo].[DimTimeZone] dtz on fc.TimeZoneKey = dtz.TimeZoneKey
					) h
		INNER JOIN [dbo].[DimBusinessAccount] dba ON h.BusinessAccountKey = dba.BusinessAccountKey
		INNER JOIN [dbo].[DimAdAccount] da ON h.AdAccountKey = da.AdAccountKey
		INNER JOIN [dbo].[DimAffiliate] daf ON h.AffiliateKey = daf.AffiliateKey
		INNER JOIN [dbo].[DimCampaign] dc ON h.CampaignKey = dc.CampaignKey
		INNER JOIN [dbo].[DimSource] ds ON h.SpendSourceKey = ds.SourceKey
	WHERE CAST(h.[Date] AS DATE) = @Date
		AND dba.BusinessAccountKey = @BusinessAccountKey
		AND da.AdAccountKey = @AdAccountKey
		AND daf.AffiliateKey = @AffiliateKey 
		AND dc.CampaignKey = @CampaignKey '

	IF @ROI = 'negative'
		SET @SQL = @SQL + ' AND CASE WHEN h.Spend = 0 THEN 0 ELSE h.Profit / h.Spend END < 0 '

	IF @ROI = 'positive'
		SET @SQL = @SQL + ' AND CASE WHEN h.Spend = 0 THEN 0 ELSE h.Profit / h.Spend END >= 0 '
    SET @SQL = @SQL + ' ORDER BY DATEPART(HOUR, h.[Date]) '

	--print @SQL

	EXEC sp_executesql @SQL,@params,@BusinessAccountKey,@AdAccountKey,@AffiliateKey,@CampaignKey,@TimeZoneOffset,@Date 

END
GO
PRINT N'Creating [rep].[AlphaTeamReport]...';


GO
CREATE PROCEDURE [rep].[AlphaTeamReport]
	@BusinessAccountKey nvarchar(max) = NULL,
	@AdAccountKey nvarchar(max) = NULL,
	@AffiliateKey nvarchar(max) = NULL,
	@CampaignKey nvarchar(max) = NULL,
	@ROI nvarchar(20) = NULL, /* negative / positive / ELSE - both */
	@TimeZoneKey int = 0,
	@DateFrom date = NULL,
	@DateTo date = NULL
AS
BEGIN
	SET NOCOUNT ON;

	DECLARE 
		@TimeZoneOffset int,
		@TimeZoneOffsetStr nvarchar(20) = 'dtz.TimeZoneOffset',
		@SQL nvarchar(max),
		@params nvarchar(max),
		@WhereClause nvarchar(max),
		@OrderByClause nvarchar(max)


	SET @params = '
			 @BusinessAccountKey nvarchar(max) = NULL
			,@AdAccountKey nvarchar(max) = NULL
			,@AffiliateKey nvarchar(max) = NULL
			,@CampaignKey nvarchar(max) = NULL
			,@TimeZoneOffset int = 0
	        ,@DateFrom date = NULL
	        ,@DateTo date = NULL
	     '
	
	IF @TimeZoneKey > 0
	BEGIN
		SELECT @TimeZoneOffset = TimeZoneOffset FROM [dbo].[DimTimeZone] WHERE TimeZoneKey = @TimeZoneKey
		SET @TimeZoneOffsetStr = '@TimeZoneOffset'
	END

	
	SET @SQL = '
	SELECT 	 
			 [Date] = agr.[Date] 
			,[BusinessAccountKey] = dba.BusinessAccountKey
			,[BusinessAccount] = dba.BusinessAccountName
			,[AdAccountKey] = da.AdAccountKey
			,[AdAccount] = da.AdAccountName
			,[AffiliateKey] = daf.AffiliateKey
			,[Affiliate] = daf.AffiliateName
			,[CampaignKey] = dc.CampaignKey
			,[Campaign] = dc.CampaignName
			,[Source] = ds.SourceName
			,[Rev] = agr.Revenue
			,[MaxRev] = MAX(agr.Revenue) OVER()
			,[Spend] = agr.Spend
			,[MaxSpend] = MAX(agr.Spend) OVER()
			,[Profit] = agr.Profit
			,[ROI] = CASE WHEN agr.Spend = 0 THEN 0 ELSE agr.Profit / agr.Spend END
		FROM (
				SELECT h.[Date], h.AffiliateKey, h.BusinessAccountKey, h.AdAccountKey, h.CampaignKey, h.SpendSourceKey
						,Revenue = SUM(h.Revenue), Spend = SUM(h.Spend), Profit = SUM(h.Profit)
				FROM (
					SELECT 
						 [Date] = CAST(SWITCHOFFSET(dd.FullDate, 60 * (' + @TimeZoneOffsetStr + ' + fc.DLS)) AS DATE)
						,fc.AffiliateKey
						,fc.BusinessAccountKey
						,fc.AdAccountKey
						,fc.CampaignKey
						,fc.SpendSourceKey
						,fc.Revenue
						,fc.Spend
						,fc.Profit
					FROM [dbo].[FactCampaign] fc
						INNER JOIN [dbo].[DimDate] dd ON fc.DateKey = dd.DateKey
						INNER JOIN [dbo].[DimTimeZone] dtz on fc.TimeZoneKey = dtz.TimeZoneKey
						) h
				WHERE (h.[Date] >= @DateFrom) AND (h.[Date] <= @DateTo)
				GROUP BY h.[Date], h.AffiliateKey, h.BusinessAccountKey, h.AdAccountKey, h.CampaignKey, h.SpendSourceKey) agr
			INNER JOIN [dbo].[DimBusinessAccount] dba ON agr.BusinessAccountKey = dba.BusinessAccountKey
			INNER JOIN [dbo].[DimAdAccount] da ON agr.AdAccountKey = da.AdAccountKey
			INNER JOIN [dbo].[DimAffiliate] daf ON agr.AffiliateKey = daf.AffiliateKey
			INNER JOIN [dbo].[DimCampaign] dc ON agr.CampaignKey = dc.CampaignKey
			INNER JOIN [dbo].[DimSource] ds ON agr.SpendSourceKey = ds.SourceKey
		WHERE (dba.BusinessAccountKey IN (SELECT * FROM utils.[CSVToTable](@BusinessAccountKey, '','')))
			AND (da.AdAccountKey IN (SELECT * FROM utils.[CSVToTable](@AdAccountKey, '','')))
			AND (daf.AffiliateKey IN (SELECT * FROM utils.[CSVToTable](@AffiliateKey, '','')))
			AND (dc.CampaignKey IN (SELECT * FROM utils.[CSVToTable](@CampaignKey, '',''))) '

	IF @ROI = 'negative'
		SET @SQL = @SQL + ' AND CASE WHEN agr.Spend = 0 THEN 0 ELSE agr.Profit / agr.Spend END < 0 '

	IF @ROI = 'positive'
		SET @SQL = @SQL + ' AND CASE WHEN agr.Spend = 0 THEN 0 ELSE agr.Profit / agr.Spend END >= 0 '

    SET @SQL = @SQL + ' ORDER BY agr.[Date] DESC, ds.SourceName, dba.BusinessAccountName, da.AdAccountName, dc.CampaignName '

	--print @SQL

	EXEC sp_executesql @SQL,@params,@BusinessAccountKey,@AdAccountKey,@AffiliateKey,@CampaignKey,@TimeZoneOffset,@DateFrom,@DateTo

END
GO
PRINT N'Creating [etl].[Load_DimTimeZone]...';


GO
CREATE PROCEDURE [etl].[Load_DimTimeZone]
AS
BEGIN
	/* Get max key value */
	DECLARE @maxKeyValue int;
	SET @maxKeyValue = CASE WHEN ISNULL((SELECT MAX(a.TimeZoneKey) FROM dbo.DimTimeZone a (NOLOCK)), 0) < 0 THEN 0 ELSE ISNULL((SELECT MAX(a.TimeZoneKey) FROM dbo.DimTimeZone a (NOLOCK)), 0) END;

	MERGE INTO dbo.DimTimeZone d
	USING(
			SELECT 
				RowNumber = ROW_NUMBER() OVER (ORDER BY dt.[TimeZoneKey]),
				[TimeZoneBK] = tz.timezone_id,
				[TimeZoneName] = tz.timezone_name,
				[TimeZoneOffset] = tz.timezone_offset_hours_utc
			FROM (SELECT DISTINCT timezone_id, timezone_name, timezone_offset_hours_utc FROM [stage].[FBAdaccounts] (NOLOCK)) tz
			LEFT JOIN [dbo].[DimTimeZone] dt (NOLOCK) ON tz.timezone_id = dt.TimeZoneBK

		)tz ON (tz.[TimeZoneBK] = d.[TimeZoneBK])
	WHEN MATCHED THEN
		UPDATE SET
			[TimeZoneName] = tz.[TimeZoneName],
			[TimeZoneOffset] = tz.[TimeZoneOffset]
	WHEN NOT MATCHED THEN
		INSERT
		(
			[TimeZoneKey],
			[TimeZoneBK],
			[TimeZoneName],
			[TimeZoneOffset]
		)
		VALUES
		(
			@maxKeyValue + tz.RowNumber,
			tz.[TimeZoneBK],
			tz.[TimeZoneName],
			tz.[TimeZoneOffset]
		);


	/* Add Unknown Affiliate */
	IF ISNULL((SELECT COUNT(*) FROM dbo.[DimTimeZone] dt WHERE dt.[TimeZoneKey] = -1), 0)=0
		INSERT INTO dbo.[DimTimeZone] ([TimeZoneKey], [TimeZoneBK], [TimeZoneName], [TimeZoneOffset]) values(-1, -1, 'Unknown', 0);

END
GO
PRINT N'Creating [etl].[Load_DimBusinessAccount]...';


GO
CREATE PROCEDURE [etl].[Load_DimBusinessAccount]
AS
BEGIN
	/* Get max key value */
	DECLARE @maxKeyValue int;
	SET @maxKeyValue = CASE WHEN ISNULL((SELECT MAX(a.BusinessAccountKey) FROM dbo.DimBusinessAccount a (NOLOCK)), 0) < 0 THEN 0 ELSE ISNULL((SELECT MAX(a.BusinessAccountKey) FROM dbo.DimBusinessAccount a (NOLOCK)), 0) END;

	MERGE INTO dbo.DimBusinessAccount d
	USING(
			SELECT 
				RowNumber = ROW_NUMBER() OVER (ORDER BY da.BusinessAccountKey),
				BusinessAccountBK = a.id,
				BusinessAccountName = a.name
			FROM (SELECT DISTINCT id, name FROM [stage].[FBBusinessAccounts] (NOLOCK)) a
			LEFT JOIN [dbo].[DimBusinessAccount] da (NOLOCK) ON a.id = da.[BusinessAccountBK]
		)a ON (a.BusinessAccountBK = d.BusinessAccountBK)
	WHEN MATCHED THEN
		UPDATE SET
			BusinessAccountName = a.BusinessAccountName
	WHEN NOT MATCHED THEN
		INSERT
		(
			BusinessAccountKey,
			BusinessAccountBK,
			BusinessAccountName
		)
		VALUES
		(
			@maxKeyValue + a.RowNumber,
			a.BusinessAccountBK,
			a.BusinessAccountName
		);


			/* Add Unknown Business Account */
	IF ISNULL((SELECT COUNT(*) FROM dbo.[DimBusinessAccount] da WHERE da.BusinessAccountKey = -1), 0)=0
		INSERT INTO dbo.[DimBusinessAccount] (BusinessAccountKey, BusinessAccountBK, BusinessAccountName) values(-1, -1, 'Unknown');

END
GO
PRINT N'Creating [etl].[Load_DimAffiliate]...';


GO
CREATE PROCEDURE [etl].[Load_DimAffiliate]
AS
BEGIN
	/* Get max key value */
	DECLARE @maxKeyValue int;
	SET @maxKeyValue = CASE WHEN ISNULL((SELECT MAX(a.AffiliateKey) FROM dbo.DimAffiliate a (NOLOCK)), 0) < 0 THEN 0 ELSE ISNULL((SELECT MAX(a.AffiliateKey) FROM dbo.DimAffiliate a (NOLOCK)), 0) END;

	MERGE INTO dbo.DimAffiliate d
	USING(
			SELECT 
				RowNumber = ROW_NUMBER() OVER (ORDER BY da.AffiliateKey),
				AffiliateBK = a.affiliate_id,
				AffiliateName = a.affiliate_name
			FROM (SELECT DISTINCT [affiliate_id], [affiliate_name] FROM [stage].[CakeConversions] (NOLOCK)) a
			LEFT JOIN [dbo].[DimAffiliate] da (NOLOCK) ON a.[affiliate_id] = da.AffiliateBK
		)a ON (a.AffiliateBK = d.AffiliateBK)
	WHEN MATCHED THEN
		UPDATE SET
			AffiliateName = a.AffiliateName
	WHEN NOT MATCHED THEN
		INSERT
		(
			AffiliateKey,
			AffiliateBK,
			AffiliateName
		)
		VALUES
		(
			@maxKeyValue + a.RowNumber,
			a.AffiliateBK,
			a.AffiliateName
		);


			/* Add Unknown Affiliate */
	IF ISNULL((SELECT COUNT(*) FROM dbo.[DimAffiliate] da WHERE da.AffiliateKey = -1), 0)=0
		INSERT INTO dbo.[DimAffiliate] (AffiliateKey, AffiliateBK, AffiliateName) values(-1, -1, 'Unknown');

END
GO
PRINT N'Creating [etl].[Load_DimAdAccount]...';


GO
CREATE PROCEDURE [etl].[Load_DimAdAccount]
AS
BEGIN
	/* Get max key value */
	DECLARE @maxKeyValue int;
	SET @maxKeyValue = CASE WHEN ISNULL((SELECT MAX(a.AdAccountKey) FROM dbo.DimAdAccount a (NOLOCK)), 0) < 0 THEN 0 ELSE ISNULL((SELECT MAX(a.AdAccountKey) FROM dbo.DimAdAccount a (NOLOCK)), 0) END;

	MERGE INTO dbo.DimAdAccount d
	USING(
			SELECT 
				RowNumber = ROW_NUMBER() OVER (ORDER BY da.AdAccountKey),
				AdAccountBK = a.account_id,
				AdAccountName = a.name
			FROM (SELECT DISTINCT account_id, name FROM [stage].[FBAdaccounts] (NOLOCK)) a
			LEFT JOIN [dbo].[DimAdAccount] da (NOLOCK) ON a.account_id = da.[AdAccountBK]
		)a ON (a.AdAccountBK = d.AdAccountBK)
	WHEN MATCHED THEN
		UPDATE SET
			AdAccountName = a.AdAccountName
	WHEN NOT MATCHED THEN
		INSERT
		(
			AdAccountKey,
			AdAccountBK,
			AdAccountName
		)
		VALUES
		(
			@maxKeyValue + a.RowNumber,
			a.AdAccountBK,
			a.AdAccountName
		);


			/* Add Unknown Ad Account */
	IF ISNULL((SELECT COUNT(*) FROM dbo.[DimAdAccount] da WHERE da.AdAccountKey = -1), 0)=0
		INSERT INTO dbo.[DimAdAccount] (AdAccountKey, AdAccountBK, AdAccountName) values(-1, -1, 'Unknown');

END
GO
PRINT N'Creating [etl].[Load_FactCampaign]...';


GO
CREATE PROCEDURE [etl].[Load_FactCampaign]
	@InsightsDate DATE = NULL
AS
BEGIN
	
	MERGE INTO [dbo].[FactCampaign] fc
	USING(
			SELECT 
				 [SpendSourceKey] = ISNULL(dss.[SourceKey], -1)
				,[RevenueSourceKey] = ISNULL(dsr.[SourceKey], -1)
				,[BusinessAccountKey] = ISNULL(dba.[BusinessAccountKey], -1)
				,[AdAccountKey] = ISNULL(da.[AdAccountKey], -1)
				,[AffiliateKey] = ISNULL(daf.[AffiliateKey], -1)
				,[CampaignKey] = ISNULL(dc.[CampaignKey], -1)
				,[ProductKey] = -1
				,[DateKey] = dd.[DateKey]
				,[TimeZoneKey] = ISNULL(dtz.[TimeZoneKey], 4)
				,[DLS] = st.dls
				,[LinkId] = st.fb_id
				,[Spend] = st.spend
				,[Revenue] = st.Revenue
				,[Profit] =  st.Revenue - st.spend
			FROM(
					select 'Facebook' as spend_source, 'CAKE' as revenue_source, ac.[business_id], u.affiliate_id, ac.account_id, u.campaign_id,
							u.fb_id, ac.timezone_id, u.insight_utc_date, u.dls, sum(u.revenue) as revenue, sum(u.spend) as spend
					from (
						select	isnull(i.affiliate_id, a.affiliate_id) as affiliate_id
								,isnull(i.campaign_id, c.campaign_id) as campaign_id
								,i.fb_id
								,i.insight_utc_date
								,i.dls
								,i.spend 
								,i.revenue
						from (select cu.affiliate_id,
								fu.campaign_id,
								ISNULL(fu.fb_id, cu.fb_id) as fb_id, 
								ISNULL(fu.insight_utc_date, cu.insight_utc_date) as insight_utc_date,
								ISNULL(fu.dls, cu.dls) as dls, 
								ISNULL(fu.spend, 0) as spend,
								ISNULL(cu.revenue, 0) as revenue
							from [stage].[FBCampaignInsightsUTC] fu
								full join [stage].[CakeCampaignInsightsUTC]  cu ON fu.fb_id = cu.fb_id and fu.insight_utc_date = cu.insight_utc_date
							where (@InsightsDate is null or (CAST(ISNULL(fu.insight_utc_date, cu.insight_utc_date) as date) BETWEEN dateadd(day, -1, @InsightsDate) AND dateadd(day, 1, @InsightsDate)))) i
							left join (select distinct campaign_id, fb_id from [stage].[FBCampaignInsightsUTC]) c on i.fb_id = c.fb_id and i.campaign_id is null
							left join (select distinct fb_id, affiliate_id from [stage].[CakeCampaignInsightsUTC]) a on i.fb_id = a.fb_id and i.affiliate_id is null 
						) u
					left join [stage].[FBCampaigns] c on c.campaign_id = u.campaign_id
					left join [stage].[FBAdaccounts] ac on ac.account_id = c.account_id
					group by ac.[business_id], ac.account_id, u.affiliate_id, u.campaign_id, u.fb_id, ac.timezone_id, u.insight_utc_date, u.dls ) st
			LEFT JOIN [dbo].[DimBusinessAccount] dba ON dba.[BusinessAccountBK] = st.business_id
			LEFT JOIN [dbo].[DimAdAccount] da ON da.[AdAccountBK] = st.account_id
			LEFT JOIN [dbo].[DimAffiliate] daf ON daf.[AffiliateBK] = st.affiliate_id
			LEFT JOIN [dbo].[DimSource] dss ON dss.[SourceName] = st.spend_source
			LEFT JOIN [dbo].[DimSource] dsr ON dsr.[SourceName] = st.revenue_source
			LEFT JOIN [dbo].[DimCampaign] dc ON dc.[CampaignBK] = st.campaign_id
			LEFT JOIN [dbo].[DimDate] dd ON dd.FullDate = st.insight_utc_date
			LEFT JOIN [dbo].[DimTimeZone] dtz ON dtz.[TimeZoneBK] = st.timezone_id
		WHERE (st.spend <> 0 OR st.Revenue <> 0)
	) c ON (c.[DateKey] = fc.[DateKey] AND c.[AffiliateKey] = fc.[AffiliateKey] AND c.[CampaignKey] = fc.[CampaignKey] AND c.[LinkId] = fc.[LinkId])
	WHEN MATCHED THEN
			UPDATE SET
				 [AffiliateKey] = c.[AffiliateKey]
				,[DLS] = c.[DLS]
				,[Spend] = c.[Spend]
				,[Revenue] = c.[Revenue]
				,[Profit] = c.[Profit]
	WHEN NOT MATCHED THEN
			INSERT 
			([SpendSourceKey], [RevenueSourceKey], [BusinessAccountKey], [AdAccountKey], [AffiliateKey], [CampaignKey], [ProductKey], [DateKey], [TimeZoneKey], [DLS], [LinkId], [Spend], [Revenue], [Profit])
			VALUES (c.[SpendSourceKey], c.[RevenueSourceKey], c.[BusinessAccountKey], c.[AdAccountKey], c.[AffiliateKey], c.[CampaignKey], c.[ProductKey], c.[DateKey], c.[TimeZoneKey], c.[DLS], c.[LinkId], c.[Spend], c.[Revenue], c.[Profit]);

	RETURN 0;

END
GO
PRINT N'Creating [etl].[Load_DimCampaign]...';


GO
CREATE PROCEDURE [etl].[Load_DimCampaign]
AS
BEGIN

	/* Get max key value */
	DECLARE @maxKeyValue int;
	SET @maxKeyValue = CASE WHEN ISNULL((SELECT MAX(c.CampaignKey) FROM dbo.DimCampaign c (NOLOCK)), 0) < 0 THEN 0 ELSE ISNULL((SELECT MAX(c.CampaignKey) FROM dbo.DimCampaign c (NOLOCK)), 0) END;

	MERGE INTO dbo.DimCampaign dc
	USING(
			SELECT 
				RowNumber = ROW_NUMBER() OVER (ORDER BY dc.CampaignKey),
				CampaignBK = a.campaign_id,
				CampaignName = a.campaign_name
			FROM (SELECT DISTINCT campaign_id, campaign_name FROM [stage].[FBCampaigns] (NOLOCK)) a
			LEFT JOIN [dbo].[DimCampaign] dc (NOLOCK) ON a.campaign_id = dc.[CampaignBK]
		)c ON (c.CampaignBK = dc.CampaignBK)
	WHEN MATCHED THEN
		UPDATE SET
			CampaignName = c.CampaignName
	WHEN NOT MATCHED THEN
		INSERT
		(
			CampaignKey,
			CampaignBK,
			CampaignName
		)
		VALUES
		(
			@maxKeyValue + c.RowNumber,
			c.CampaignBK,
			c.CampaignName
		);


	/* Add Unknown Campaign */
	IF ISNULL((SELECT COUNT(*) FROM dbo.[DimCampaign] dc WHERE dc.CampaignKey = -1), 0)=0
		INSERT INTO dbo.[DimCampaign] (CampaignKey, CampaignBK, CampaignName) values(-1, -1, 'Unknown');

END
GO
PRINT N'Creating [etl].[Load_DimAd]...';


GO
CREATE PROCEDURE [etl].[Load_DimAd]
AS
BEGIN

	/* 
		Get max key value 
	*/
	DECLARE @maxKeyValue int;
	SET @maxKeyValue = CASE WHEN ISNULL((SELECT MAX(a.AdKey) FROM dbo.DimAd a (NOLOCK)), 0) < 0 THEN 0 ELSE ISNULL((SELECT MAX(a.AdKey) FROM dbo.DimAd a (NOLOCK)), 0) END;

	MERGE INTO dbo.DimAd da
	USING(
			SELECT 
				RowNumber = ROW_NUMBER() OVER (ORDER BY da.AdKey),
				AdBK = a.Id,
				AdName = a.Name
			FROM (SELECT DISTINCT Id, Name FROM [stage].[FBAds] (NOLOCK)) a
			LEFT JOIN [dbo].[DimAd] da (NOLOCK) ON a.id = da.[AdBK]
		)a ON (a.AdBK = da.AdBK)
	WHEN MATCHED THEN
		UPDATE SET
			AdName = a.AdName
	WHEN NOT MATCHED THEN
		INSERT
		(
			AdKey,
			AdBK,
			AdName
		)
		VALUES
		(
			@maxKeyValue + a.RowNumber,
			a.AdBK,
			a.AdName
		);
END
GO
PRINT N'Creating [etl].[Load_DimProduct]...';


GO
CREATE PROCEDURE [etl].[Load_DimProduct]
AS
BEGIN

	/* Get max key value */
	DECLARE @maxKeyValue int;
	SET @maxKeyValue = CASE WHEN ISNULL((SELECT MAX(p.ProductKey) FROM dbo.DimProduct p (NOLOCK)), 0) < 0 THEN 0 ELSE ISNULL((SELECT MAX(p.ProductKey) FROM dbo.DimProduct p (NOLOCK)), 0) END;

	--MERGE INTO dbo.DimProduct dp
	--USING(
	--		SELECT 
	--			RowNumber = ROW_NUMBER() OVER (ORDER BY dp.ProductKey),
	--			ProductName = vn.vertical_name
	--		FROM (SELECT DISTINCT vertical_name FROM [stage].[SHLCampaignSummary] (NOLOCK)
	--			  UNION ALL 
	--			  SELECT DISTINCT vertical_name FROM [stage].[A4DCampaignSummary] (NOLOCK)) vn
	--		LEFT JOIN [dbo].[DimProduct] dp (NOLOCK) ON vn.vertical_name = dp.ProductName
	--	)p ON (p.ProductName = dp.ProductName)
	--WHEN NOT MATCHED THEN
	--	INSERT
	--	(
	--		ProductKey,
	--		ProductName
	--	)
	--	values
	--	(
	--		@maxKeyValue + p.RowNumber,
	--		p.ProductName
	--	);
	/* Add Unknown Product */
	IF ISNULL((SELECT COUNT(*) FROM dbo.DimProduct p WHERE p.ProductKey=-1), 0)=0
		INSERT INTO dbo.DimProduct (ProductKey, ProductName) values(-1, '');
END
GO
PRINT N'Creating [etl].[SetLastLoadDate]...';


GO
CREATE PROCEDURE [etl].[SetLastLoadDate]
	@LastLoadDate DATETIME
AS
BEGIN
	UPDATE [dbo].[Settings] 
	SET [SettingValue] = CONVERT(varchar(20), @LastLoadDate, 20)  
	WHERE SettingName = 'LastLoadDate'
END
GO
PRINT N'Creating [etl].[GetLastLoadDate]...';


GO
CREATE PROCEDURE [etl].[GetLastLoadDate]
AS
BEGIN
	SELECT LastLoadDate = CAST([SettingValue] AS DATETIME)  FROM [dbo].[Settings] WHERE SettingName = 'LastLoadDate'
END
GO
PRINT N'Creating [etl].[Load_DimDate]...';


GO
CREATE procedure [etl].[Load_DimDate]
as
begin
	set datefirst 1;

	declare @startDate datetimeoffset = TODATETIMEOFFSET(dateadd(dd, 1, dbo.GetLastDateFromDimDate()), 0);
	
	declare @yearsCount tinyint;
	select @yearsCount = cast(SettingValue as tinyint) from dbo.Settings where SettingName = 'YearsCountToPopulate';

	declare @endDate datetimeoffset;

	if datediff(mm, @startDate, getdate()) >= -1
		begin
			if datediff(yy, @startDate, getdate()) - @yearsCount <= 0
				set @endDate = dateadd(yy, @yearsCount, @startDate)
			else
				set @endDate = dateadd(yy, datediff(yy, @startDate, getdate()) + @yearsCount, @startDate)
		end
	else
		set @endDate = dateadd(dd, -1, @startDate);

	while @startDate <= @endDate
	begin
		insert into [dbo].[DimDate]
				([DateKey]
				,[FullDate]
				,[DayOfWeek]
				,[DayNumInMonth]
				,[DayName]
				,[DayAbbrev]
				,[WeekdayFlag]
				,[WeekNumInYear]
				,[Month]
				,[MonthName]
				,[MonthAbbrev]
				,[Quarter]
				,[Year]
				,[Yearmo])
		select  
				REPLACE(REPLACE(CONVERT(nvarchar(13), @startDate, 120), '-', ''), ' ', ''),
				@startDate as 'Full_Date', 
				DATEPART (weekday, @startDate) as 'Day_Of_Week',
				DATEPART (d, @startDate) as 'Day_Num_In_Month',
				DATENAME (dw, @startDate) as 'Day_Name',
				LEFT (DATENAME (dw, @startDate), 3) 'Day_Abbrev',
				case when DATEPART (dw, @startDate) < 6 then 'y' else 'n' end as 'Weekday_Flag',
				DATEPART (ww, @startDate) as 'Week_Num_In_Year',
				MONTH(@startDate) as 'Month',
				DATENAME (mm, @startDate) as 'Month_Name',
				LEFT(DATENAME (mm, @startDate), 3) as 'Month_Abbrev',
				DATEPART(qq, @startDate) as 'Quarter',
				YEAR(@startDate) as 'Year',
				REPLACE (LEFT (CONVERT(nvarchar, @startDate, 102), 7), '.', '') as 'Yearmo'
		set @startDate = DATEADD (hour, 1, @startDate)
	end
end
GO
PRINT N'Creating [DatabaseVersion]...';


GO
EXECUTE sp_addextendedproperty @name = N'DatabaseVersion', @value = N'0.1';


GO
/*
Post-Deployment Script Template							
--------------------------------------------------------------------------------------
 This file contains SQL statements that will be appended to the build script.		
 Use SQLCMD syntax to include a file in the post-deployment script.			
 Example:      :r .\myfile.sql								
 Use SQLCMD syntax to reference a variable in the post-deployment script.		
 Example:      :setvar TableName MyTable							
               SELECT * FROM [$(TableName)]					
--------------------------------------------------------------------------------------
*/

INSERT INTO [dbo].[Settings] ([SettingKey], [SettingName], [SettingValue]) VALUES (1, 'Test setting', 31)
GO

GO
DECLARE @VarDecimalSupported AS BIT;

SELECT @VarDecimalSupported = 0;

IF ((ServerProperty(N'EngineEdition') = 3)
    AND (((@@microsoftversion / power(2, 24) = 9)
          AND (@@microsoftversion & 0xffff >= 3024))
         OR ((@@microsoftversion / power(2, 24) = 10)
             AND (@@microsoftversion & 0xffff >= 1600))))
    SELECT @VarDecimalSupported = 1;

IF (@VarDecimalSupported > 0)
    BEGIN
        EXECUTE sp_db_vardecimal_storage_format N'$(DatabaseName)', 'ON';
    END


GO
ALTER DATABASE [$(DatabaseName)]
    SET MULTI_USER 
    WITH ROLLBACK IMMEDIATE;


GO
PRINT N'Update complete.';


GO
