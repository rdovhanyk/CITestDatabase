<?xml version="1.0" encoding="utf-8"?>
<DataSchemaModel FileFormatVersion="1.2" SchemaVersion="2.4" DspName="Microsoft.Data.Tools.Schema.Sql.Sql110DatabaseSchemaProvider" CollationLcid="1058" CollationCaseSensitive="False" xmlns="http://schemas.microsoft.com/sqlserver/dac/Serialization/2012/02">
	<Header>
		<CustomData Category="AnsiNulls">
			<Metadata Name="AnsiNulls" Value="True" />
		</CustomData>
		<CustomData Category="QuotedIdentifier">
			<Metadata Name="QuotedIdentifier" Value="True" />
		</CustomData>
		<CustomData Category="CompatibilityMode">
			<Metadata Name="CompatibilityMode" Value="110" />
		</CustomData>
		<CustomData Category="Reference" Type="Assembly">
			<Metadata Name="LogicalName" Value="CITestDatabase.dll" />
			<Metadata Name="FileName" Value="D:\PROJECTS\AMAZON_TEST\GIT\CITESTDATABASE\CITESTDATABASE\OBJ\DEBUG\CITESTDATABASE.DLL" />
			<Metadata Name="AssemblyName" Value="CITestDatabase" />
			<Metadata Name="PermissionSet" Value="EXTERNAL_ACCESS" />
			<Metadata Name="Owner" Value="" />
			<Metadata Name="GenerateSqlClrDdl" Value="True" />
			<Metadata Name="IsVisible" Value="True" />
			<Metadata Name="IsModelAware" Value="True" />
			<Metadata Name="SkipCreationIfEmpty" Value="True" />
			<Metadata Name="AssemblySymbolsName" Value="D:\Projects\AMAZON_TEST\GIT\CITestDatabase\CITestDatabase\obj\Debug\CITestDatabase.pdb" />
		</CustomData>
		<CustomData Category="SqlCmdVariables" Type="SqlCmdVariable" />
	</Header>
	<Model>
		<Element Type="SqlDatabaseOptions" Disambiguator="1">
			<Property Name="Collation" Value="Ukrainian_CI_AS" />
			<Property Name="IsAnsiNullDefaultOn" Value="True" />
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Property Name="IsAnsiWarningsOn" Value="True" />
			<Property Name="IsArithAbortOn" Value="True" />
			<Property Name="IsConcatNullYieldsNullOn" Value="True" />
			<Property Name="IsTornPageProtectionOn" Value="False" />
			<Property Name="IsFullTextEnabled" Value="True" />
			<Property Name="PageVerifyMode" Value="3" />
			<Property Name="DefaultLanguage" Value="" />
			<Property Name="DefaultFullTextLanguage" Value="" />
			<Relationship Name="DefaultFilegroup">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[PRIMARY]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[((0))]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[stage].[FBCampaignInsightsUTC]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[stage].[FBCampaignInsightsUTC].[dls]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="4" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[((0))]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[stage].[CakeCampaignInsightsUTC]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[stage].[CakeCampaignInsightsUTC].[dls]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="5" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[((0))]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[FactCampaign]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[FactCampaign].[DLS]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="6" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[((-1))]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[FactCampaign]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[FactCampaign].[BusinessAccountKey]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="7" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[((-1))]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[FactCampaign]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[FactCampaign].[AdAccountKey]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="8" />
		</Element>
		<Element Type="SqlDefaultConstraint">
			<Property Name="DefaultExpressionScript">
				<Value><![CDATA[((-1))]]></Value>
			</Property>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[FactCampaign]" />
				</Entry>
			</Relationship>
			<Relationship Name="ForColumn">
				<Entry>
					<References Name="[dbo].[FactCampaign].[AffiliateKey]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="9" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[Users].[Id]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[Users]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="10" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[DimSource].[SourceKey]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[DimSource]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="11" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[DimProduct].[ProductKey]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[DimProduct]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="12" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[DimCampaign].[CampaignKey]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[DimCampaign]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="13" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[DimBusinessAccount].[BusinessAccountKey]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[DimBusinessAccount]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="14" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[DimAffiliate].[AffiliateKey]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[DimAffiliate]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="15" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[DimAdAccount].[AdAccountKey]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[DimAdAccount]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="16" />
		</Element>
		<Element Type="SqlPrimaryKeyConstraint">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[stage].[StageErrorLog].[Id]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[stage].[StageErrorLog]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="17" />
		</Element>
		<Element Type="SqlTable" Name="[dbo].[DimAdAccount]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimAdAccount].[AdAccountKey]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimAdAccount].[AdAccountBK]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="25" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimAdAccount].[AdAccountName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="16" />
		</Element>
		<Element Type="SqlTable" Name="[dbo].[DimAffiliate]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimAffiliate].[AffiliateKey]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimAffiliate].[AffiliateBK]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimAffiliate].[AffiliateName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="64" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="15" />
		</Element>
		<Element Type="SqlTable" Name="[dbo].[DimBusinessAccount]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimBusinessAccount].[BusinessAccountKey]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimBusinessAccount].[BusinessAccountBK]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="25" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimBusinessAccount].[BusinessAccountName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="14" />
		</Element>
		<Element Type="SqlTable" Name="[dbo].[DimCampaign]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimCampaign].[CampaignKey]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimCampaign].[CampaignBK]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="25" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimCampaign].[CampaignName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="13" />
		</Element>
		<Element Type="SqlTable" Name="[dbo].[DimDate]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimDate].[DateKey]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimDate].[FullDate]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Scale" Value="7" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetimeoffset]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimDate].[DayOfWeek]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[tinyint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimDate].[DayNumInMonth]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[tinyint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimDate].[DayName]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="9" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimDate].[DayAbbrev]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="3" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[char]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimDate].[WeekdayFlag]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="1" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[char]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimDate].[WeekNumInYear]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[tinyint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimDate].[Month]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[tinyint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimDate].[MonthName]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="9" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimDate].[MonthAbbrev]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="3" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[char]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimDate].[Quarter]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[tinyint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimDate].[Year]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[smallint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimDate].[Yearmo]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Annotation Type="SqlInlineConstraintAnnotation" Disambiguator="18" />
		</Element>
		<Element Type="SqlTable" Name="[dbo].[DimProduct]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimProduct].[ProductKey]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimProduct].[ProductName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="64" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="12" />
		</Element>
		<Element Type="SqlTable" Name="[dbo].[DimSource]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimSource].[SourceKey]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimSource].[SourceName]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="64" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="11" />
		</Element>
		<Element Type="SqlTable" Name="[dbo].[DimTimeZone]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimTimeZone].[TimeZoneKey]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimTimeZone].[TimeZoneBK]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimTimeZone].[TimeZoneName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="64" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[DimTimeZone].[TimeZoneOffset]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlTable" Name="[dbo].[FactCampaign]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FactCampaign].[DateKey]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FactCampaign].[TimeZoneKey]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FactCampaign].[DLS]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[smallint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="6" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FactCampaign].[RevenueSourceKey]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FactCampaign].[SpendSourceKey]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FactCampaign].[BusinessAccountKey]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="7" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FactCampaign].[AdAccountKey]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="8" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FactCampaign].[ProductKey]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FactCampaign].[AffiliateKey]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="9" />
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FactCampaign].[CampaignKey]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FactCampaign].[LinkId]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FactCampaign].[Revenue]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Scale" Value="2" />
									<Property Name="Precision" Value="12" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[decimal]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FactCampaign].[Spend]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Scale" Value="2" />
									<Property Name="Precision" Value="12" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[decimal]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[FactCampaign].[Profit]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Scale" Value="2" />
									<Property Name="Precision" Value="12" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[decimal]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlInlineTableValuedFunction" Name="[dbo].[GetDateMonthRange]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[dbo].[GetDateMonthRange].[@StartDate]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetDateMonthRange].[CTE1].[lst].[dt]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetDateMonthRange].[@EndDate]" />
				</Entry>
			</Relationship>
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlComputedColumn" Name="[dbo].[GetDateMonthRange].[dt]">
						<Relationship Name="ExpressionDependencies">
							<Entry>
								<References Name="[dbo].[GetDateMonthRange].[@StartDate]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[dbo].[GetDateMonthRange].[CTE1].[lst]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[dbo].[GetDateMonthRange].[CTE1].[lst].[dt]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[dbo].[GetDateMonthRange].[@StartDate]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="FunctionBody">
				<Entry>
					<Element Type="SqlScriptFunctionImplementation">
						<Property Name="BodyScript">
							<Value><![CDATA[ 
(
	WITH lst AS (
		SELECT @StartDate AS dt
		UNION ALL
		SELECT DATEADD(MONTH, 1, dt) dt
		  FROM lst s 
		 WHERE DATEADD(MONTH, 1, dt) <= @EndDate )
	SELECT * FROM lst 
)]]></Value>
						</Property>
						<Annotation Type="SysCommentsObjectAnnotation">
							<Property Name="Length" Value="324" />
							<Property Name="StartLine" Value="1" />
							<Property Name="StartColumn" Value="1" />
							<Property Name="HeaderContents" Value="CREATE FUNCTION [dbo].[GetDateMonthRange]&#xD;&#xA;(&#x9;&#xD;&#xA;&#x9;@StartDate datetime,&#xD;&#xA;&#x9;@EndDate datetime&#xD;&#xA;)&#xD;&#xA;/* Test Comment 11 */&#xD;&#xA;RETURNS TABLE &#xD;&#xA;AS&#xD;&#xA;RETURN" />
						</Annotation>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[GetDateMonthRange].[@StartDate]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[GetDateMonthRange].[@EndDate]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlScalarFunction" Name="[dbo].[GetFirstDateOfYear]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[dbo].[GetFirstDateOfYear].[@dt]" />
				</Entry>
			</Relationship>
			<Relationship Name="FunctionBody">
				<Entry>
					<Element Type="SqlScriptFunctionImplementation">
						<Property Name="BodyScript">
							<Value><![CDATA[
begin
	return(select datefromparts(year(@dt), 1, 1));
end]]></Value>
						</Property>
						<Annotation Type="SysCommentsObjectAnnotation">
							<Property Name="Length" Value="127" />
							<Property Name="StartLine" Value="1" />
							<Property Name="StartColumn" Value="1" />
							<Property Name="HeaderContents" Value="create function dbo.GetFirstDateOfYear(@dt date)&#xD;&#xA;returns date&#xD;&#xA;as" />
						</Annotation>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[GetFirstDateOfYear].[@dt]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[date]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Relationship Name="Type">
				<Entry>
					<Element Type="SqlTypeSpecifier">
						<Relationship Name="Type">
							<Entry>
								<References ExternalSource="BuiltIns" Name="[date]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlScalarFunction" Name="[dbo].[GetLastDateFromDimDate]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[smalldatetime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimDate]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimDate].[FullDate]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Settings]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Settings].[SettingValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Settings].[SettingName]" />
				</Entry>
			</Relationship>
			<Relationship Name="FunctionBody">
				<Entry>
					<Element Type="SqlScriptFunctionImplementation">
						<Property Name="BodyScript">
							<Value><![CDATA[
begin
	declare @lastDate smalldatetime
	select @lastDate = max(FullDate) from dbo.DimDate;

	if @lastDate is null
		select @lastDate = SettingValue from dbo.Settings where SettingName = 'StartDate';

	return @lastDate
end]]></Value>
						</Property>
						<Annotation Type="SysCommentsObjectAnnotation">
							<Property Name="Length" Value="306" />
							<Property Name="StartLine" Value="1" />
							<Property Name="StartColumn" Value="1" />
							<Property Name="HeaderContents" Value="CREATE function [dbo].[GetLastDateFromDimDate]()&#xD;&#xA;returns smalldatetime&#xD;&#xA;as" />
						</Annotation>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Relationship Name="Type">
				<Entry>
					<Element Type="SqlTypeSpecifier">
						<Relationship Name="Type">
							<Entry>
								<References ExternalSource="BuiltIns" Name="[smalldatetime]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlScalarFunction" Name="[dbo].[GetLinkParameterValue]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[dbo].[GetLinkParameterValue].[@ParameterName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetLinkParameterValue].[@Link]" />
				</Entry>
			</Relationship>
			<Relationship Name="FunctionBody">
				<Entry>
					<Element Type="SqlScriptFunctionImplementation">
						<Property Name="BodyScript">
							<Value><![CDATA[
BEGIN

	SET @ParameterName = @ParameterName + '='

	IF CHARINDEX(@ParameterName, @Link, 0) <= 0 
		RETURN NULL

	SET @link = SUBSTRING(@Link, CHARINDEX(@ParameterName, @Link, 0) + LEN(@ParameterName), LEN(@Link)) 
	RETURN RTRIM(SUBSTRING(@Link, 0, CASE WHEN CHARINDEX('&', @Link, 0) > 0 THEN CHARINDEX('&', @Link, 0) ELSE LEN(@Link) + 1 END))


END]]></Value>
						</Property>
						<Annotation Type="SysCommentsObjectAnnotation">
							<Property Name="Length" Value="482" />
							<Property Name="StartLine" Value="1" />
							<Property Name="StartColumn" Value="1" />
							<Property Name="HeaderContents" Value="CREATE FUNCTION [dbo].[GetLinkParameterValue](@Link nvarchar(255), @ParameterName nvarchar(32))&#xD;&#xA;RETURNS NVARCHAR(64)&#xD;&#xA;AS" />
						</Annotation>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[GetLinkParameterValue].[@Link]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[GetLinkParameterValue].[@ParameterName]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="32" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Relationship Name="Type">
				<Entry>
					<Element Type="SqlTypeSpecifier">
						<Property Name="Length" Value="64" />
						<Relationship Name="Type">
							<Entry>
								<References ExternalSource="BuiltIns" Name="[nvarchar]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlScalarFunction" Name="[dbo].[GetUSDaylightSaving]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[datetime]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[datetime]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[datetime]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[datetime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetUSDaylightSaving].[@dt]" />
				</Entry>
			</Relationship>
			<Relationship Name="FunctionBody">
				<Entry>
					<Element Type="SqlScriptFunctionImplementation">
						<Property Name="BodyScript">
							<Value><![CDATA[
BEGIN

	--SET DATEFIRST 7

	DECLARE
		@year INT,
		@StartOfMarch DATETIME ,
		@StartOfNovember DATETIME ,
		@DstStart DATETIME ,
		@DstEnd DATETIME

	SET @year = year(@dt)
	SET @StartOfMarch = DATEADD(MONTH, 2, DATEADD(YEAR, @year - 1900, 0))
	SET @StartOfNovember = DATEADD(MONTH, 10, DATEADD(YEAR, @year - 1900, 0));
	SET @DstStart = DATEADD(HOUR, 2,
							DATEADD(day,
									( ( 15 - DATEPART(dw, @StartOfMarch) ) % 7 )
									+ 7, @StartOfMarch))
	SET @DstEnd = DATEADD(HOUR, 2,
						  DATEADD(day,
								  ( ( 8 - DATEPART(dw, @StartOfNovember) ) % 7 ),
								  @StartOfNovember))

	--select @DstStart, @DstEnd
	RETURN(SELECT CASE WHEN @dt BETWEEN @DstStart AND @DstEnd THEN -1 ELSE 0 END)

END]]></Value>
						</Property>
						<Annotation Type="SysCommentsObjectAnnotation">
							<Property Name="Length" Value="804" />
							<Property Name="StartLine" Value="1" />
							<Property Name="StartColumn" Value="1" />
							<Property Name="HeaderContents" Value="CREATE FUNCTION dbo.GetUSDaylightSaving(@dt date)&#xD;&#xA;RETURNS INT&#xD;&#xA;AS" />
						</Annotation>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[dbo].[GetUSDaylightSaving].[@dt]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[date]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<Relationship Name="Type">
				<Entry>
					<Element Type="SqlTypeSpecifier">
						<Relationship Name="Type">
							<Entry>
								<References ExternalSource="BuiltIns" Name="[int]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlPrimaryKeyConstraint" Name="[dbo].[PK_DimDate]">
			<Relationship Name="ColumnSpecifications">
				<Entry>
					<Element Type="SqlIndexedColumnSpecification">
						<Relationship Name="Column">
							<Entry>
								<References Name="[dbo].[DimDate].[DateKey]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="DefiningTable">
				<Entry>
					<References Name="[dbo].[DimDate]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="18" />
		</Element>
		<Element Type="SqlTable" Name="[dbo].[Settings]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Settings].[SettingKey]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Settings].[SettingName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Settings].[SettingValue]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlTable" Name="[dbo].[UserAffiliates]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[UserAffiliates].[UserId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[UserAffiliates].[AffiliateId]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlTable" Name="[dbo].[Users]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Users].[Id]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Users].[UserName]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="128" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[dbo].[Users].[Mail]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="128" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="10" />
		</Element>
		<Element Type="SqlSchema" Name="[etl]">
			<Relationship Name="Authorizer">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlProcedure" Name="[etl].[GetLastLoadDate]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SELECT LastLoadDate = CAST([SettingValue] AS DATETIME)  FROM [dbo].[Settings] WHERE SettingName = 'LastLoadDate'
END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[dbo].[Settings]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[datetime]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Settings].[SettingValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Settings].[SettingName]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[etl]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="171" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [etl].[GetLastLoadDate]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[etl].[Load_DimAd]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN

	/* 
		Get max key value 
	*/
	DECLARE @maxKeyValue int;
	SET @maxKeyValue = CASE WHEN ISNULL((SELECT MAX(a.AdKey) FROM dbo.DimAd a (NOLOCK)), 0) < 0 THEN 0 ELSE ISNULL((SELECT MAX(a.AdKey) FROM dbo.DimAd a (NOLOCK)), 0) END;

	MERGE INTO dbo.DimAd da
	USING(
			SELECT 
				RowNumber = ROW_NUMBER() OVER (ORDER BY da.AdKey),
				AdBK = a.Id,
				AdName = a.Name
			FROM (SELECT DISTINCT Id, Name FROM [stage].[FBAds] (NOLOCK)) a
			LEFT JOIN [dbo].[DimAd] da (NOLOCK) ON a.id = da.[AdBK]
		)a ON (a.AdBK = da.AdBK)
	WHEN MATCHED THEN
		UPDATE SET
			AdName = a.AdName
	WHEN NOT MATCHED THEN
		INSERT
		(
			AdKey,
			AdBK,
			AdName
		)
		VALUES
		(
			@maxKeyValue + a.RowNumber,
			a.AdBK,
			a.AdName
		);
END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry />
				<Entry />
				<Entry>
					<References Name="[stage].[FBAds]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAds].[id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAds].[name]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAds].[id]" />
				</Entry>
				<Entry />
				<Entry />
				<Entry>
					<References Name="[stage].[FBAds].[id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAds].[name]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAds].[id]" />
				</Entry>
				<Entry />
				<Entry />
				<Entry>
					<References Name="[stage].[FBAds].[name]" />
				</Entry>
				<Entry />
				<Entry />
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[etl]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="794" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [etl].[Load_DimAd]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[etl].[Load_DimAdAccount]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	/* Get max key value */
	DECLARE @maxKeyValue int;
	SET @maxKeyValue = CASE WHEN ISNULL((SELECT MAX(a.AdAccountKey) FROM dbo.DimAdAccount a (NOLOCK)), 0) < 0 THEN 0 ELSE ISNULL((SELECT MAX(a.AdAccountKey) FROM dbo.DimAdAccount a (NOLOCK)), 0) END;

	MERGE INTO dbo.DimAdAccount d
	USING(
			SELECT 
				RowNumber = ROW_NUMBER() OVER (ORDER BY da.AdAccountKey),
				AdAccountBK = a.account_id,
				AdAccountName = a.name
			FROM (SELECT DISTINCT account_id, name FROM [stage].[FBAdaccounts] (NOLOCK)) a
			LEFT JOIN [dbo].[DimAdAccount] da (NOLOCK) ON a.account_id = da.[AdAccountBK]
		)a ON (a.AdAccountBK = d.AdAccountBK)
	WHEN MATCHED THEN
		UPDATE SET
			AdAccountName = a.AdAccountName
	WHEN NOT MATCHED THEN
		INSERT
		(
			AdAccountKey,
			AdAccountBK,
			AdAccountName
		)
		VALUES
		(
			@maxKeyValue + a.RowNumber,
			a.AdAccountBK,
			a.AdAccountName
		);


			/* Add Unknown Ad Account */
	IF ISNULL((SELECT COUNT(*) FROM dbo.[DimAdAccount] da WHERE da.AdAccountKey = -1), 0)=0
		INSERT INTO dbo.[DimAdAccount] (AdAccountKey, AdAccountBK, AdAccountName) values(-1, -1, 'Unknown');

END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimAdAccount]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimAdAccount].[AdAccountKey]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[account_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[name]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[account_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimAdAccount].[AdAccountBK]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimAdAccount].[AdAccountKey]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[account_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[name]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[account_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimAdAccount].[AdAccountBK]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimAdAccount].[AdAccountName]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimAdAccount].[AdAccountKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimAdAccount].[AdAccountBK]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[etl]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="1187" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [etl].[Load_DimAdAccount]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[etl].[Load_DimAffiliate]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	/* Get max key value */
	DECLARE @maxKeyValue int;
	SET @maxKeyValue = CASE WHEN ISNULL((SELECT MAX(a.AffiliateKey) FROM dbo.DimAffiliate a (NOLOCK)), 0) < 0 THEN 0 ELSE ISNULL((SELECT MAX(a.AffiliateKey) FROM dbo.DimAffiliate a (NOLOCK)), 0) END;

	MERGE INTO dbo.DimAffiliate d
	USING(
			SELECT 
				RowNumber = ROW_NUMBER() OVER (ORDER BY da.AffiliateKey),
				AffiliateBK = a.affiliate_id,
				AffiliateName = a.affiliate_name
			FROM (SELECT DISTINCT [affiliate_id], [affiliate_name] FROM [stage].[CakeConversions] (NOLOCK)) a
			LEFT JOIN [dbo].[DimAffiliate] da (NOLOCK) ON a.[affiliate_id] = da.AffiliateBK
		)a ON (a.AffiliateBK = d.AffiliateBK)
	WHEN MATCHED THEN
		UPDATE SET
			AffiliateName = a.AffiliateName
	WHEN NOT MATCHED THEN
		INSERT
		(
			AffiliateKey,
			AffiliateBK,
			AffiliateName
		)
		VALUES
		(
			@maxKeyValue + a.RowNumber,
			a.AffiliateBK,
			a.AffiliateName
		);


			/* Add Unknown Affiliate */
	IF ISNULL((SELECT COUNT(*) FROM dbo.[DimAffiliate] da WHERE da.AffiliateKey = -1), 0)=0
		INSERT INTO dbo.[DimAffiliate] (AffiliateKey, AffiliateBK, AffiliateName) values(-1, -1, 'Unknown');

END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimAffiliate]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimAffiliate].[AffiliateKey]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeConversions]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeConversions].[affiliate_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeConversions].[affiliate_name]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeConversions].[affiliate_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimAffiliate].[AffiliateBK]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimAffiliate].[AffiliateKey]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeConversions].[affiliate_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeConversions].[affiliate_name]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeConversions].[affiliate_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimAffiliate].[AffiliateBK]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimAffiliate].[AffiliateName]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeConversions].[affiliate_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimAffiliate].[AffiliateKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimAffiliate].[AffiliateBK]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[etl]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="1219" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [etl].[Load_DimAffiliate]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[etl].[Load_DimBusinessAccount]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	/* Get max key value */
	DECLARE @maxKeyValue int;
	SET @maxKeyValue = CASE WHEN ISNULL((SELECT MAX(a.BusinessAccountKey) FROM dbo.DimBusinessAccount a (NOLOCK)), 0) < 0 THEN 0 ELSE ISNULL((SELECT MAX(a.BusinessAccountKey) FROM dbo.DimBusinessAccount a (NOLOCK)), 0) END;

	MERGE INTO dbo.DimBusinessAccount d
	USING(
			SELECT 
				RowNumber = ROW_NUMBER() OVER (ORDER BY da.BusinessAccountKey),
				BusinessAccountBK = a.id,
				BusinessAccountName = a.name
			FROM (SELECT DISTINCT id, name FROM [stage].[FBBusinessAccounts] (NOLOCK)) a
			LEFT JOIN [dbo].[DimBusinessAccount] da (NOLOCK) ON a.id = da.[BusinessAccountBK]
		)a ON (a.BusinessAccountBK = d.BusinessAccountBK)
	WHEN MATCHED THEN
		UPDATE SET
			BusinessAccountName = a.BusinessAccountName
	WHEN NOT MATCHED THEN
		INSERT
		(
			BusinessAccountKey,
			BusinessAccountBK,
			BusinessAccountName
		)
		VALUES
		(
			@maxKeyValue + a.RowNumber,
			a.BusinessAccountBK,
			a.BusinessAccountName
		);


			/* Add Unknown Business Account */
	IF ISNULL((SELECT COUNT(*) FROM dbo.[DimBusinessAccount] da WHERE da.BusinessAccountKey = -1), 0)=0
		INSERT INTO dbo.[DimBusinessAccount] (BusinessAccountKey, BusinessAccountBK, BusinessAccountName) values(-1, -1, 'Unknown');

END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimBusinessAccount]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimBusinessAccount].[BusinessAccountKey]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBBusinessAccounts]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBBusinessAccounts].[id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBBusinessAccounts].[name]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBBusinessAccounts].[id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimBusinessAccount].[BusinessAccountBK]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimBusinessAccount].[BusinessAccountKey]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBBusinessAccounts].[id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBBusinessAccounts].[name]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBBusinessAccounts].[id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimBusinessAccount].[BusinessAccountBK]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimBusinessAccount].[BusinessAccountName]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBBusinessAccounts].[name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimBusinessAccount].[BusinessAccountKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimBusinessAccount].[BusinessAccountBK]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[etl]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="1331" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [etl].[Load_DimBusinessAccount]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[etl].[Load_DimCampaign]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN

	/* Get max key value */
	DECLARE @maxKeyValue int;
	SET @maxKeyValue = CASE WHEN ISNULL((SELECT MAX(c.CampaignKey) FROM dbo.DimCampaign c (NOLOCK)), 0) < 0 THEN 0 ELSE ISNULL((SELECT MAX(c.CampaignKey) FROM dbo.DimCampaign c (NOLOCK)), 0) END;

	MERGE INTO dbo.DimCampaign dc
	USING(
			SELECT 
				RowNumber = ROW_NUMBER() OVER (ORDER BY dc.CampaignKey),
				CampaignBK = a.campaign_id,
				CampaignName = a.campaign_name
			FROM (SELECT DISTINCT campaign_id, campaign_name FROM [stage].[FBCampaigns] (NOLOCK)) a
			LEFT JOIN [dbo].[DimCampaign] dc (NOLOCK) ON a.campaign_id = dc.[CampaignBK]
		)c ON (c.CampaignBK = dc.CampaignBK)
	WHEN MATCHED THEN
		UPDATE SET
			CampaignName = c.CampaignName
	WHEN NOT MATCHED THEN
		INSERT
		(
			CampaignKey,
			CampaignBK,
			CampaignName
		)
		VALUES
		(
			@maxKeyValue + c.RowNumber,
			c.CampaignBK,
			c.CampaignName
		);


	/* Add Unknown Campaign */
	IF ISNULL((SELECT COUNT(*) FROM dbo.[DimCampaign] dc WHERE dc.CampaignKey = -1), 0)=0
		INSERT INTO dbo.[DimCampaign] (CampaignKey, CampaignBK, CampaignName) values(-1, -1, 'Unknown');

END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimCampaign]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimCampaign].[CampaignKey]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_name]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimCampaign].[CampaignBK]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimCampaign].[CampaignKey]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_name]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimCampaign].[CampaignBK]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimCampaign].[CampaignName]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimCampaign].[CampaignKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimCampaign].[CampaignBK]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[etl]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="1181" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [etl].[Load_DimCampaign]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[etl].[Load_DimDate]">
			<Property Name="BodyScript">
				<Value><![CDATA[
begin
	set datefirst 1;

	declare @startDate datetimeoffset = TODATETIMEOFFSET(dateadd(dd, 1, dbo.GetLastDateFromDimDate()), 0);
	
	declare @yearsCount tinyint;
	select @yearsCount = cast(SettingValue as tinyint) from dbo.Settings where SettingName = 'YearsCountToPopulate';

	declare @endDate datetimeoffset;

	if datediff(mm, @startDate, getdate()) >= -1
		begin
			if datediff(yy, @startDate, getdate()) - @yearsCount <= 0
				set @endDate = dateadd(yy, @yearsCount, @startDate)
			else
				set @endDate = dateadd(yy, datediff(yy, @startDate, getdate()) + @yearsCount, @startDate)
		end
	else
		set @endDate = dateadd(dd, -1, @startDate);

	while @startDate <= @endDate
	begin
		insert into [dbo].[DimDate]
				([DateKey]
				,[FullDate]
				,[DayOfWeek]
				,[DayNumInMonth]
				,[DayName]
				,[DayAbbrev]
				,[WeekdayFlag]
				,[WeekNumInYear]
				,[Month]
				,[MonthName]
				,[MonthAbbrev]
				,[Quarter]
				,[Year]
				,[Yearmo])
		select  
				REPLACE(REPLACE(CONVERT(nvarchar(13), @startDate, 120), '-', ''), ' ', ''),
				@startDate as 'Full_Date', 
				DATEPART (weekday, @startDate) as 'Day_Of_Week',
				DATEPART (d, @startDate) as 'Day_Num_In_Month',
				DATENAME (dw, @startDate) as 'Day_Name',
				LEFT (DATENAME (dw, @startDate), 3) 'Day_Abbrev',
				case when DATEPART (dw, @startDate) < 6 then 'y' else 'n' end as 'Weekday_Flag',
				DATEPART (ww, @startDate) as 'Week_Num_In_Year',
				MONTH(@startDate) as 'Month',
				DATENAME (mm, @startDate) as 'Month_Name',
				LEFT(DATENAME (mm, @startDate), 3) as 'Month_Abbrev',
				DATEPART(qq, @startDate) as 'Quarter',
				YEAR(@startDate) as 'Year',
				REPLACE (LEFT (CONVERT(nvarchar, @startDate, 102), 7), '.', '') as 'Yearmo'
		set @startDate = DATEADD (hour, 1, @startDate)
	end
end]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[datetimeoffset]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetLastDateFromDimDate]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[datetimeoffset]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Settings]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[tinyint]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Settings].[SettingValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Settings].[SettingName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimDate]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimDate].[DateKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimDate].[FullDate]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimDate].[DayOfWeek]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimDate].[DayNumInMonth]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimDate].[DayName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimDate].[DayAbbrev]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimDate].[WeekdayFlag]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimDate].[WeekNumInYear]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimDate].[Month]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimDate].[MonthName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimDate].[MonthAbbrev]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimDate].[Quarter]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimDate].[Year]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimDate].[Yearmo]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[etl]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="1855" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE procedure [etl].[Load_DimDate]&#xD;&#xA;as" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[etl].[Load_DimProduct]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN

	/* Get max key value */
	DECLARE @maxKeyValue int;
	SET @maxKeyValue = CASE WHEN ISNULL((SELECT MAX(p.ProductKey) FROM dbo.DimProduct p (NOLOCK)), 0) < 0 THEN 0 ELSE ISNULL((SELECT MAX(p.ProductKey) FROM dbo.DimProduct p (NOLOCK)), 0) END;

	--MERGE INTO dbo.DimProduct dp
	--USING(
	--		SELECT 
	--			RowNumber = ROW_NUMBER() OVER (ORDER BY dp.ProductKey),
	--			ProductName = vn.vertical_name
	--		FROM (SELECT DISTINCT vertical_name FROM [stage].[SHLCampaignSummary] (NOLOCK)
	--			  UNION ALL 
	--			  SELECT DISTINCT vertical_name FROM [stage].[A4DCampaignSummary] (NOLOCK)) vn
	--		LEFT JOIN [dbo].[DimProduct] dp (NOLOCK) ON vn.vertical_name = dp.ProductName
	--	)p ON (p.ProductName = dp.ProductName)
	--WHEN NOT MATCHED THEN
	--	INSERT
	--	(
	--		ProductKey,
	--		ProductName
	--	)
	--	values
	--	(
	--		@maxKeyValue + p.RowNumber,
	--		p.ProductName
	--	);
	/* Add Unknown Product */
	IF ISNULL((SELECT COUNT(*) FROM dbo.DimProduct p WHERE p.ProductKey=-1), 0)=0
		INSERT INTO dbo.DimProduct (ProductKey, ProductName) values(-1, '');
END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimProduct]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimProduct].[ProductKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimProduct].[ProductKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimProduct].[ProductName]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[etl]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="1131" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [etl].[Load_DimProduct]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[etl].[Load_DimTimeZone]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	/* Get max key value */
	DECLARE @maxKeyValue int;
	SET @maxKeyValue = CASE WHEN ISNULL((SELECT MAX(a.TimeZoneKey) FROM dbo.DimTimeZone a (NOLOCK)), 0) < 0 THEN 0 ELSE ISNULL((SELECT MAX(a.TimeZoneKey) FROM dbo.DimTimeZone a (NOLOCK)), 0) END;

	MERGE INTO dbo.DimTimeZone d
	USING(
			SELECT 
				RowNumber = ROW_NUMBER() OVER (ORDER BY dt.[TimeZoneKey]),
				[TimeZoneBK] = tz.timezone_id,
				[TimeZoneName] = tz.timezone_name,
				[TimeZoneOffset] = tz.timezone_offset_hours_utc
			FROM (SELECT DISTINCT timezone_id, timezone_name, timezone_offset_hours_utc FROM [stage].[FBAdaccounts] (NOLOCK)) tz
			LEFT JOIN [dbo].[DimTimeZone] dt (NOLOCK) ON tz.timezone_id = dt.TimeZoneBK

		)tz ON (tz.[TimeZoneBK] = d.[TimeZoneBK])
	WHEN MATCHED THEN
		UPDATE SET
			[TimeZoneName] = tz.[TimeZoneName],
			[TimeZoneOffset] = tz.[TimeZoneOffset]
	WHEN NOT MATCHED THEN
		INSERT
		(
			[TimeZoneKey],
			[TimeZoneBK],
			[TimeZoneName],
			[TimeZoneOffset]
		)
		VALUES
		(
			@maxKeyValue + tz.RowNumber,
			tz.[TimeZoneBK],
			tz.[TimeZoneName],
			tz.[TimeZoneOffset]
		);


	/* Add Unknown Affiliate */
	IF ISNULL((SELECT COUNT(*) FROM dbo.[DimTimeZone] dt WHERE dt.[TimeZoneKey] = -1), 0)=0
		INSERT INTO dbo.[DimTimeZone] ([TimeZoneKey], [TimeZoneBK], [TimeZoneName], [TimeZoneOffset]) values(-1, -1, 'Unknown', 0);

END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimTimeZone]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimTimeZone].[TimeZoneKey]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[timezone_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[timezone_name]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[timezone_offset_hours_utc]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[timezone_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimTimeZone].[TimeZoneBK]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimTimeZone].[TimeZoneKey]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[timezone_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[timezone_name]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[timezone_offset_hours_utc]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[timezone_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimTimeZone].[TimeZoneBK]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimTimeZone].[TimeZoneName]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[timezone_name]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimTimeZone].[TimeZoneOffset]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[timezone_offset_hours_utc]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimTimeZone].[TimeZoneKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimTimeZone].[TimeZoneBK]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[etl]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="1414" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [etl].[Load_DimTimeZone]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[etl].[Load_FactCampaign]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	
	MERGE INTO [dbo].[FactCampaign] fc
	USING(
			SELECT 
				 [SpendSourceKey] = ISNULL(dss.[SourceKey], -1)
				,[RevenueSourceKey] = ISNULL(dsr.[SourceKey], -1)
				,[BusinessAccountKey] = ISNULL(dba.[BusinessAccountKey], -1)
				,[AdAccountKey] = ISNULL(da.[AdAccountKey], -1)
				,[AffiliateKey] = ISNULL(daf.[AffiliateKey], -1)
				,[CampaignKey] = ISNULL(dc.[CampaignKey], -1)
				,[ProductKey] = -1
				,[DateKey] = dd.[DateKey]
				,[TimeZoneKey] = ISNULL(dtz.[TimeZoneKey], 4)
				,[DLS] = st.dls
				,[LinkId] = st.fb_id
				,[Spend] = st.spend
				,[Revenue] = st.Revenue
				,[Profit] =  st.Revenue - st.spend
			FROM(
					select 'Facebook' as spend_source, 'CAKE' as revenue_source, ac.[business_id], u.affiliate_id, ac.account_id, u.campaign_id,
							u.fb_id, ac.timezone_id, u.insight_utc_date, u.dls, sum(u.revenue) as revenue, sum(u.spend) as spend
					from (
						select	isnull(i.affiliate_id, a.affiliate_id) as affiliate_id
								,isnull(i.campaign_id, c.campaign_id) as campaign_id
								,i.fb_id
								,i.insight_utc_date
								,i.dls
								,i.spend 
								,i.revenue
						from (select cu.affiliate_id,
								fu.campaign_id,
								ISNULL(fu.fb_id, cu.fb_id) as fb_id, 
								ISNULL(fu.insight_utc_date, cu.insight_utc_date) as insight_utc_date,
								ISNULL(fu.dls, cu.dls) as dls, 
								ISNULL(fu.spend, 0) as spend,
								ISNULL(cu.revenue, 0) as revenue
							from [stage].[FBCampaignInsightsUTC] fu
								full join [stage].[CakeCampaignInsightsUTC]  cu ON fu.fb_id = cu.fb_id and fu.insight_utc_date = cu.insight_utc_date
							where (@InsightsDate is null or (CAST(ISNULL(fu.insight_utc_date, cu.insight_utc_date) as date) BETWEEN dateadd(day, -1, @InsightsDate) AND dateadd(day, 1, @InsightsDate)))) i
							left join (select distinct campaign_id, fb_id from [stage].[FBCampaignInsightsUTC]) c on i.fb_id = c.fb_id and i.campaign_id is null
							left join (select distinct fb_id, affiliate_id from [stage].[CakeCampaignInsightsUTC]) a on i.fb_id = a.fb_id and i.affiliate_id is null 
						) u
					left join [stage].[FBCampaigns] c on c.campaign_id = u.campaign_id
					left join [stage].[FBAdaccounts] ac on ac.account_id = c.account_id
					group by ac.[business_id], ac.account_id, u.affiliate_id, u.campaign_id, u.fb_id, ac.timezone_id, u.insight_utc_date, u.dls ) st
			LEFT JOIN [dbo].[DimBusinessAccount] dba ON dba.[BusinessAccountBK] = st.business_id
			LEFT JOIN [dbo].[DimAdAccount] da ON da.[AdAccountBK] = st.account_id
			LEFT JOIN [dbo].[DimAffiliate] daf ON daf.[AffiliateBK] = st.affiliate_id
			LEFT JOIN [dbo].[DimSource] dss ON dss.[SourceName] = st.spend_source
			LEFT JOIN [dbo].[DimSource] dsr ON dsr.[SourceName] = st.revenue_source
			LEFT JOIN [dbo].[DimCampaign] dc ON dc.[CampaignBK] = st.campaign_id
			LEFT JOIN [dbo].[DimDate] dd ON dd.FullDate = st.insight_utc_date
			LEFT JOIN [dbo].[DimTimeZone] dtz ON dtz.[TimeZoneBK] = st.timezone_id
		WHERE (st.spend <> 0 OR st.Revenue <> 0)
	) c ON (c.[DateKey] = fc.[DateKey] AND c.[AffiliateKey] = fc.[AffiliateKey] AND c.[CampaignKey] = fc.[CampaignKey] AND c.[LinkId] = fc.[LinkId])
	WHEN MATCHED THEN
			UPDATE SET
				 [AffiliateKey] = c.[AffiliateKey]
				,[DLS] = c.[DLS]
				,[Spend] = c.[Spend]
				,[Revenue] = c.[Revenue]
				,[Profit] = c.[Profit]
	WHEN NOT MATCHED THEN
			INSERT 
			([SpendSourceKey], [RevenueSourceKey], [BusinessAccountKey], [AdAccountKey], [AffiliateKey], [CampaignKey], [ProductKey], [DateKey], [TimeZoneKey], [DLS], [LinkId], [Spend], [Revenue], [Profit])
			VALUES (c.[SpendSourceKey], c.[RevenueSourceKey], c.[BusinessAccountKey], c.[AdAccountKey], c.[AffiliateKey], c.[CampaignKey], c.[ProductKey], c.[DateKey], c.[TimeZoneKey], c.[DLS], c.[LinkId], c.[Spend], c.[Revenue], c.[Profit]);

	RETURN 0;

END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[stage].[FBCampaignInsightsUTC]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeCampaignInsightsUTC]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaignInsightsUTC].[fb_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeCampaignInsightsUTC].[fb_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaignInsightsUTC].[insight_utc_date]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeCampaignInsightsUTC].[insight_utc_date]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeCampaignInsightsUTC].[affiliate_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaignInsightsUTC].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaignInsightsUTC].[dls]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeCampaignInsightsUTC].[dls]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaignInsightsUTC].[spend]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeCampaignInsightsUTC].[revenue]" />
				</Entry>
				<Entry>
					<References Name="[etl].[Load_FactCampaign].[@InsightsDate]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[date]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaignInsightsUTC].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaignInsightsUTC].[fb_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaignInsightsUTC].[fb_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaignInsightsUTC].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeCampaignInsightsUTC].[fb_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeCampaignInsightsUTC].[affiliate_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeCampaignInsightsUTC].[fb_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeCampaignInsightsUTC].[affiliate_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeCampaignInsightsUTC].[affiliate_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaignInsightsUTC].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[account_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[account_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[business_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[timezone_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimBusinessAccount]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimBusinessAccount].[BusinessAccountBK]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[business_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimAdAccount]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimAdAccount].[AdAccountBK]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[account_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimAffiliate]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimAffiliate].[AffiliateBK]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimSource]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimSource].[SourceName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimSource].[SourceName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimCampaign]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimCampaign].[CampaignBK]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimDate]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimDate].[FullDate]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimTimeZone]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimTimeZone].[TimeZoneBK]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[timezone_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimSource].[SourceKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimSource].[SourceKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimBusinessAccount].[BusinessAccountKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimAdAccount].[AdAccountKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimAffiliate].[AffiliateKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimCampaign].[CampaignKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimDate].[DateKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimTimeZone].[TimeZoneKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FactCampaign]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimDate].[DateKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FactCampaign].[DateKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FactCampaign].[AffiliateKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FactCampaign].[CampaignKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FactCampaign].[LinkId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FactCampaign].[AffiliateKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FactCampaign].[DLS]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FactCampaign].[Spend]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FactCampaign].[Revenue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FactCampaign].[Profit]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FactCampaign].[SpendSourceKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FactCampaign].[RevenueSourceKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FactCampaign].[BusinessAccountKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FactCampaign].[AdAccountKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FactCampaign].[CampaignKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FactCampaign].[ProductKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FactCampaign].[DateKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FactCampaign].[TimeZoneKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FactCampaign].[LinkId]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[etl].[Load_FactCampaign].[@InsightsDate]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[date]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[etl]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="3937" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [etl].[Load_FactCampaign]&#xD;&#xA;&#x9;@InsightsDate DATE = NULL&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[etl].[SetLastLoadDate]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	UPDATE [dbo].[Settings] 
	SET [SettingValue] = CONVERT(varchar(20), @LastLoadDate, 20)  
	WHERE SettingName = 'LastLoadDate'
END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[dbo].[Settings]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Settings].[SettingValue]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References Name="[etl].[SetLastLoadDate].[@LastLoadDate]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Settings].[SettingName]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[etl].[SetLastLoadDate].[@LastLoadDate]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[etl]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="210" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [etl].[SetLastLoadDate]&#xD;&#xA;&#x9;@LastLoadDate DATETIME&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlSchema" Name="[rep]">
			<Relationship Name="Authorizer">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlProcedure" Name="[rep].[AlphaTeamHourlyDetailsReport]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	DECLARE 
		@TimeZoneOffset int,
		@TimeZoneOffsetStr nvarchar(20) = 'dtz.TimeZoneOffset',
		@SQL nvarchar(max),
		@params nvarchar(max)


	SET @params = '
			 @BusinessAccountKey int = NULL
			,@AdAccountKey int = NULL
			,@AffiliateKey int = NULL
			,@CampaignKey int = NULL
			,@TimeZoneOffset int = 0
	        ,@Date date = NULL
	     '
	
	IF @TimeZoneKey > 0
	BEGIN
		SELECT @TimeZoneOffset = TimeZoneOffset FROM [dbo].[DimTimeZone] WHERE TimeZoneKey = @TimeZoneKey
		SET @TimeZoneOffsetStr = '@TimeZoneOffset'
	END

	
	SET @SQL = '
	SELECT 
		 [Date] = h.[Date]
		,[Hour] = DATEPART(HOUR, h.[Date])
		,[BusinessAccount] = dba.BusinessAccountName
		,[AdAccount] = da.AdAccountName
		,[Affiliate] = daf.AffiliateName
		,[Campaign] = dc.CampaignName
		,[Source] = ds.SourceName
		,[LinkId] = h.LinkId
		,[Rev] = h.Revenue
		,[MaxRev] = MAX(h.Revenue) OVER()
		,[Spend] = h.Spend
		,[MaxSpend] = MAX(h.Spend) OVER()
		,[Profit] = h.Profit
		,[ROI] = CASE WHEN h.Spend = 0 THEN 0 ELSE h.Profit / h.Spend END
			FROM (
				SELECT 
					 [Date] = CAST(SWITCHOFFSET(dd.FullDate, 60 * (' + @TimeZoneOffsetStr + ' + fc.DLS)) AS DATETIME)
					,fc.AffiliateKey
					,fc.BusinessAccountKey
					,fc.AdAccountKey
					,fc.CampaignKey
					,fc.SpendSourceKey
					,fc.LinkId
					,fc.Revenue
					,fc.Spend
					,fc.Profit
				FROM [dbo].[FactCampaign] fc
					INNER JOIN [dbo].[DimDate] dd ON fc.DateKey = dd.DateKey
					INNER JOIN [dbo].[DimTimeZone] dtz on fc.TimeZoneKey = dtz.TimeZoneKey
					) h
		INNER JOIN [dbo].[DimBusinessAccount] dba ON h.BusinessAccountKey = dba.BusinessAccountKey
		INNER JOIN [dbo].[DimAdAccount] da ON h.AdAccountKey = da.AdAccountKey
		INNER JOIN [dbo].[DimAffiliate] daf ON h.AffiliateKey = daf.AffiliateKey
		INNER JOIN [dbo].[DimCampaign] dc ON h.CampaignKey = dc.CampaignKey
		INNER JOIN [dbo].[DimSource] ds ON h.SpendSourceKey = ds.SourceKey
	WHERE CAST(h.[Date] AS DATE) = @Date
		AND dba.BusinessAccountKey = @BusinessAccountKey
		AND da.AdAccountKey = @AdAccountKey
		AND daf.AffiliateKey = @AffiliateKey 
		AND dc.CampaignKey = @CampaignKey '

	IF @ROI = 'negative'
		SET @SQL = @SQL + ' AND CASE WHEN h.Spend = 0 THEN 0 ELSE h.Profit / h.Spend END < 0 '

	IF @ROI = 'positive'
		SET @SQL = @SQL + ' AND CASE WHEN h.Spend = 0 THEN 0 ELSE h.Profit / h.Spend END >= 0 '
    SET @SQL = @SQL + ' ORDER BY DATEPART(HOUR, h.[Date]) '

	--print @SQL

	EXEC sp_executesql @SQL,@params,@BusinessAccountKey,@AdAccountKey,@AffiliateKey,@CampaignKey,@TimeZoneOffset,@Date 

END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[rep].[AlphaTeamHourlyDetailsReport].[@TimeZoneKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimTimeZone]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimTimeZone].[TimeZoneOffset]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimTimeZone].[TimeZoneKey]" />
				</Entry>
				<Entry>
					<References Name="[rep].[AlphaTeamHourlyDetailsReport].[@ROI]" />
				</Entry>
				<Entry />
				<Entry>
					<References Name="[rep].[AlphaTeamHourlyDetailsReport].[@BusinessAccountKey]" />
				</Entry>
				<Entry>
					<References Name="[rep].[AlphaTeamHourlyDetailsReport].[@AdAccountKey]" />
				</Entry>
				<Entry>
					<References Name="[rep].[AlphaTeamHourlyDetailsReport].[@AffiliateKey]" />
				</Entry>
				<Entry>
					<References Name="[rep].[AlphaTeamHourlyDetailsReport].[@CampaignKey]" />
				</Entry>
				<Entry>
					<References Name="[rep].[AlphaTeamHourlyDetailsReport].[@Date]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[rep].[AlphaTeamHourlyDetailsReport].[@Date]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[date]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[rep].[AlphaTeamHourlyDetailsReport].[@TimeZoneKey]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[rep].[AlphaTeamHourlyDetailsReport].[@BusinessAccountKey]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[rep].[AlphaTeamHourlyDetailsReport].[@AdAccountKey]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[rep].[AlphaTeamHourlyDetailsReport].[@AffiliateKey]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[rep].[AlphaTeamHourlyDetailsReport].[@CampaignKey]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[rep].[AlphaTeamHourlyDetailsReport].[@ROI]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="20" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[rep]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="2808" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [rep].[AlphaTeamHourlyDetailsReport]&#xD;&#xA;&#x9;@Date date,&#xD;&#xA;&#x9;@TimeZoneKey int,&#xD;&#xA;&#x9;@BusinessAccountKey int,&#xD;&#xA;&#x9;@AdAccountKey int,&#xD;&#xA;&#x9;@AffiliateKey int,&#xD;&#xA;&#x9;@CampaignKey int,&#xD;&#xA;&#x9;@ROI nvarchar(20)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[rep].[AlphaTeamReport]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	DECLARE 
		@TimeZoneOffset int,
		@TimeZoneOffsetStr nvarchar(20) = 'dtz.TimeZoneOffset',
		@SQL nvarchar(max),
		@params nvarchar(max),
		@WhereClause nvarchar(max),
		@OrderByClause nvarchar(max)


	SET @params = '
			 @BusinessAccountKey nvarchar(max) = NULL
			,@AdAccountKey nvarchar(max) = NULL
			,@AffiliateKey nvarchar(max) = NULL
			,@CampaignKey nvarchar(max) = NULL
			,@TimeZoneOffset int = 0
	        ,@DateFrom date = NULL
	        ,@DateTo date = NULL
	     '
	
	IF @TimeZoneKey > 0
	BEGIN
		SELECT @TimeZoneOffset = TimeZoneOffset FROM [dbo].[DimTimeZone] WHERE TimeZoneKey = @TimeZoneKey
		SET @TimeZoneOffsetStr = '@TimeZoneOffset'
	END

	
	SET @SQL = '
	SELECT 	 
			 [Date] = agr.[Date] 
			,[BusinessAccountKey] = dba.BusinessAccountKey
			,[BusinessAccount] = dba.BusinessAccountName
			,[AdAccountKey] = da.AdAccountKey
			,[AdAccount] = da.AdAccountName
			,[AffiliateKey] = daf.AffiliateKey
			,[Affiliate] = daf.AffiliateName
			,[CampaignKey] = dc.CampaignKey
			,[Campaign] = dc.CampaignName
			,[Source] = ds.SourceName
			,[Rev] = agr.Revenue
			,[MaxRev] = MAX(agr.Revenue) OVER()
			,[Spend] = agr.Spend
			,[MaxSpend] = MAX(agr.Spend) OVER()
			,[Profit] = agr.Profit
			,[ROI] = CASE WHEN agr.Spend = 0 THEN 0 ELSE agr.Profit / agr.Spend END
		FROM (
				SELECT h.[Date], h.AffiliateKey, h.BusinessAccountKey, h.AdAccountKey, h.CampaignKey, h.SpendSourceKey
						,Revenue = SUM(h.Revenue), Spend = SUM(h.Spend), Profit = SUM(h.Profit)
				FROM (
					SELECT 
						 [Date] = CAST(SWITCHOFFSET(dd.FullDate, 60 * (' + @TimeZoneOffsetStr + ' + fc.DLS)) AS DATE)
						,fc.AffiliateKey
						,fc.BusinessAccountKey
						,fc.AdAccountKey
						,fc.CampaignKey
						,fc.SpendSourceKey
						,fc.Revenue
						,fc.Spend
						,fc.Profit
					FROM [dbo].[FactCampaign] fc
						INNER JOIN [dbo].[DimDate] dd ON fc.DateKey = dd.DateKey
						INNER JOIN [dbo].[DimTimeZone] dtz on fc.TimeZoneKey = dtz.TimeZoneKey
						) h
				WHERE (h.[Date] >= @DateFrom) AND (h.[Date] <= @DateTo)
				GROUP BY h.[Date], h.AffiliateKey, h.BusinessAccountKey, h.AdAccountKey, h.CampaignKey, h.SpendSourceKey) agr
			INNER JOIN [dbo].[DimBusinessAccount] dba ON agr.BusinessAccountKey = dba.BusinessAccountKey
			INNER JOIN [dbo].[DimAdAccount] da ON agr.AdAccountKey = da.AdAccountKey
			INNER JOIN [dbo].[DimAffiliate] daf ON agr.AffiliateKey = daf.AffiliateKey
			INNER JOIN [dbo].[DimCampaign] dc ON agr.CampaignKey = dc.CampaignKey
			INNER JOIN [dbo].[DimSource] ds ON agr.SpendSourceKey = ds.SourceKey
		WHERE (dba.BusinessAccountKey IN (SELECT * FROM utils.[CSVToTable](@BusinessAccountKey, '','')))
			AND (da.AdAccountKey IN (SELECT * FROM utils.[CSVToTable](@AdAccountKey, '','')))
			AND (daf.AffiliateKey IN (SELECT * FROM utils.[CSVToTable](@AffiliateKey, '','')))
			AND (dc.CampaignKey IN (SELECT * FROM utils.[CSVToTable](@CampaignKey, '',''))) '

	IF @ROI = 'negative'
		SET @SQL = @SQL + ' AND CASE WHEN agr.Spend = 0 THEN 0 ELSE agr.Profit / agr.Spend END < 0 '

	IF @ROI = 'positive'
		SET @SQL = @SQL + ' AND CASE WHEN agr.Spend = 0 THEN 0 ELSE agr.Profit / agr.Spend END >= 0 '

    SET @SQL = @SQL + ' ORDER BY agr.[Date] DESC, ds.SourceName, dba.BusinessAccountName, da.AdAccountName, dc.CampaignName '

	--print @SQL

	EXEC sp_executesql @SQL,@params,@BusinessAccountKey,@AdAccountKey,@AffiliateKey,@CampaignKey,@TimeZoneOffset,@DateFrom,@DateTo

END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[nvarchar]" />
				</Entry>
				<Entry>
					<References Name="[rep].[AlphaTeamReport].[@TimeZoneKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimTimeZone]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimTimeZone].[TimeZoneOffset]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimTimeZone].[TimeZoneKey]" />
				</Entry>
				<Entry>
					<References Name="[rep].[AlphaTeamReport].[@ROI]" />
				</Entry>
				<Entry />
				<Entry>
					<References Name="[rep].[AlphaTeamReport].[@BusinessAccountKey]" />
				</Entry>
				<Entry>
					<References Name="[rep].[AlphaTeamReport].[@AdAccountKey]" />
				</Entry>
				<Entry>
					<References Name="[rep].[AlphaTeamReport].[@AffiliateKey]" />
				</Entry>
				<Entry>
					<References Name="[rep].[AlphaTeamReport].[@CampaignKey]" />
				</Entry>
				<Entry>
					<References Name="[rep].[AlphaTeamReport].[@DateFrom]" />
				</Entry>
				<Entry>
					<References Name="[rep].[AlphaTeamReport].[@DateTo]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[rep].[AlphaTeamReport].[@BusinessAccountKey]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[rep].[AlphaTeamReport].[@AdAccountKey]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[rep].[AlphaTeamReport].[@AffiliateKey]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[rep].[AlphaTeamReport].[@CampaignKey]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[rep].[AlphaTeamReport].[@ROI]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="20" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[rep].[AlphaTeamReport].[@TimeZoneKey]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[0]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[rep].[AlphaTeamReport].[@DateFrom]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[date]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[rep].[AlphaTeamReport].[@DateTo]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[date]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[rep]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="3844" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [rep].[AlphaTeamReport]&#xD;&#xA;&#x9;@BusinessAccountKey nvarchar(max) = NULL,&#xD;&#xA;&#x9;@AdAccountKey nvarchar(max) = NULL,&#xD;&#xA;&#x9;@AffiliateKey nvarchar(max) = NULL,&#xD;&#xA;&#x9;@CampaignKey nvarchar(max) = NULL,&#xD;&#xA;&#x9;@ROI nvarchar(20) = NULL, /* negative / positive / ELSE - both */&#xD;&#xA;&#x9;@TimeZoneKey int = 0,&#xD;&#xA;&#x9;@DateFrom date = NULL,&#xD;&#xA;&#x9;@DateTo date = NULL&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[rep].[param_AdAccount]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	SELECT DISTINCT daa.AdAccountKey, daa.AdAccountName
	FROM [dbo].[FactCampaign] fc
		INNER JOIN [dbo].[DimAdAccount] daa ON daa.[AdAccountKey] = fc.AdAccountKey
	WHERE (@BusinessAccount IS NULL OR fc.[BusinessAccountKey] IN (SELECT * FROM [utils].[CSVToTable](@BusinessAccount, ',')))
	ORDER BY daa.AdAccountName

END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[dbo].[FactCampaign]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimAdAccount]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimAdAccount].[AdAccountKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FactCampaign].[AdAccountKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimAdAccount].[AdAccountName]" />
				</Entry>
				<Entry>
					<References Name="[rep].[param_AdAccount].[@BusinessAccount]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FactCampaign].[BusinessAccountKey]" />
				</Entry>
				<Entry>
					<References Name="[utils].[CSVToTable]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[rep].[param_AdAccount].[@BusinessAccount]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[rep]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="CreateOffset" Value="2" />
				<Property Name="Length" Value="438" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="&#xD;&#xA;CREATE PROCEDURE [rep].[param_AdAccount]&#xD;&#xA;&#x9;@BusinessAccount nvarchar(max) = NULL&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[rep].[param_Affiliate]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	SELECT [AffiliateKey], [AffiliateName] 
	FROM  [dbo].[DimAffiliate] da
		INNER JOIN [dbo].[UserAffiliates] ua ON ua.AffiliateId = da.AffiliateKey
		INNER JOIN [dbo].[Users] u ON ua.UserId = u.Id
	WHERE u.UserName = @UserId
		--AND [AffiliateKey] > -1
	ORDER BY [AffiliateName]
END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[dbo].[DimAffiliate]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[UserAffiliates]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[UserAffiliates].[AffiliateId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimAffiliate].[AffiliateKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Users]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[UserAffiliates].[UserId]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Users].[Id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimAffiliate].[AffiliateKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimAffiliate].[AffiliateName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Users].[UserName]" />
				</Entry>
				<Entry>
					<References Name="[rep].[param_Affiliate].[@UserId]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[rep].[param_Affiliate].[@UserId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="128" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[rep]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="385" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [rep].[param_Affiliate]&#xD;&#xA;&#x9;@UserId NVARCHAR(128)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[rep].[param_BusinessAccount]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	SELECT [BusinessAccountKey], [BusinessAccountName] 
	FROM [dbo].[DimBusinessAccount] 
	--WHERE [BusinessAccountKey] > -1
	ORDER BY [BusinessAccountName]
END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[dbo].[DimBusinessAccount]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimBusinessAccount].[BusinessAccountKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimBusinessAccount].[BusinessAccountName]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[rep]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="240" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [rep].[param_BusinessAccount]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[rep].[param_Campaign]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;

	SELECT DISTINCT dc.CampaignKey, dc.CampaignName
	FROM [dbo].[FactCampaign] fc
		INNER JOIN [dbo].[DimCampaign] dc ON dc.CampaignKey = fc.CampaignKey
	WHERE (@AdAccount IS NULL OR fc.AdAccountKey IN (SELECT * FROM [utils].[CSVToTable](@AdAccount, ',')))
	ORDER BY dc.CampaignName

END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[dbo].[FactCampaign]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimCampaign]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimCampaign].[CampaignKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FactCampaign].[CampaignKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimCampaign].[CampaignName]" />
				</Entry>
				<Entry>
					<References Name="[rep].[param_Campaign].[@AdAccount]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[FactCampaign].[AdAccountKey]" />
				</Entry>
				<Entry>
					<References Name="[utils].[CSVToTable]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[rep].[param_Campaign].[@AdAccount]">
						<Property Name="DefaultExpressionScript">
							<Value><![CDATA[NULL]]></Value>
						</Property>
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[rep]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="396" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [rep].[param_Campaign]&#xD;&#xA;&#x9;@AdAccount nvarchar(max) = NULL&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[rep].[param_TimeZone]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET NOCOUNT ON;
	
	SELECT r.TimeZoneKey, r.TimeZoneName
	FROM (
		SELECT TimeZoneKey = 0, TimeZoneName = 'AdAccount Time Zone' , Ord = 0
		UNION ALL
		SELECT dtz.TimeZoneKey, dtz.TimeZoneName, Ord = 1
		FROM [dbo].[DimTimeZone] dtz
		WHERE dtz.TimeZoneKey > 0) r
	ORDER BY r.Ord, r.TimeZoneName

END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[dbo].[DimTimeZone]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimTimeZone].[TimeZoneKey]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[DimTimeZone].[TimeZoneName]" />
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[rep]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="363" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [rep].[param_TimeZone]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlExtendedProperty" Name="[SqlDatabaseOptions].[DatabaseVersion]">
			<Property Name="Value">
				<Value><![CDATA[N'0.1']]></Value>
			</Property>
			<Relationship Name="Host">
				<Entry>
					<References Disambiguator="1" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlSchema" Name="[stage]">
			<Relationship Name="Authorizer">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlTable" Name="[stage].[CakeCampaignInsightsUTC]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[CakeCampaignInsightsUTC].[affiliate_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[CakeCampaignInsightsUTC].[campaign_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[CakeCampaignInsightsUTC].[fb_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[CakeCampaignInsightsUTC].[insight_utc_date]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Scale" Value="7" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetimeoffset]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[CakeCampaignInsightsUTC].[revenue]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Scale" Value="2" />
									<Property Name="Precision" Value="12" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[decimal]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[CakeCampaignInsightsUTC].[dls]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[smallint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="5" />
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[stage]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlTable" Name="[stage].[CakeClicks]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[CakeClicks].[affiliate_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[CakeClicks].[campaign_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[CakeClicks].[click_date]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[CakeClicks].[subid_3]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[stage]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlTable" Name="[stage].[CakeConversions]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[CakeConversions].[advertiser_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[CakeConversions].[affiliate_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[CakeConversions].[affiliate_name]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="64" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[CakeConversions].[campaign_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[CakeConversions].[conversion_date]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[CakeConversions].[conversion_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="64" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[CakeConversions].[conversion_type]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="64" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[CakeConversions].[creative_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[CakeConversions].[offer_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[CakeConversions].[price_paid]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Scale" Value="2" />
									<Property Name="Precision" Value="18" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[decimal]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[CakeConversions].[price_received]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Scale" Value="2" />
									<Property Name="Precision" Value="18" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[decimal]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[CakeConversions].[returned]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[CakeConversions].[subid_1]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[CakeConversions].[subid_2]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[CakeConversions].[subid_3]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[CakeConversions].[subid_4]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[CakeConversions].[subid_5]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[CakeConversions].[transaction_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="64" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[CakeConversions].[test]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bit]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[stage]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlProcedure" Name="[stage].[CleanAdAccountData]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	
	DELETE os
	FROM [stage].[FBCampaigns] c
		INNER JOIN [stage].[FBAds] a ON a.campaign_id = c.campaign_id
		INNER JOIN [stage].[FBObjectStorySpec] os ON os.ad_id = a.id
	WHERE c.account_id = @AdAccountId

	DELETE a
	FROM [stage].[FBCampaigns] c
		INNER JOIN [stage].[FBAds] a ON a.campaign_id = c.campaign_id
	WHERE c.account_id = @AdAccountId

	DELETE c
	FROM [stage].[FBCampaigns] c WHERE c.account_id = @AdAccountId
	
END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[stage].[FBCampaigns]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAds]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAds].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBObjectStorySpec]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBObjectStorySpec].[ad_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAds].[id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[account_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CleanAdAccountData].[@AdAccountId]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[account_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[account_id]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[stage].[CleanAdAccountData].[@AdAccountId]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="25" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[stage]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="525" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [stage].[CleanAdAccountData]&#xD;&#xA;@AdAccountId NVARCHAR(25)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[stage].[CleanStage]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	
	TRUNCATE TABLE [stage].[FBAdaccounts];
	TRUNCATE TABLE [stage].[FBAds];
	TRUNCATE TABLE [stage].[FBObjectStorySpec];
	TRUNCATE TABLE [stage].[FBInsights];
	TRUNCATE TABLE [stage].[CakeConversions];
	TRUNCATE TABLE [stage].[SHLCampaignSummary];
	TRUNCATE TABLE [stage].[SHLConversions];
	TRUNCATE TABLE [stage].[A4DCampaignSummary];
	TRUNCATE TABLE [stage].[A4DConversions];
	
END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[stage].[FBAdaccounts]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAds]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBObjectStorySpec]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBInsights]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeConversions]" />
				</Entry>
				<Entry />
				<Entry />
				<Entry />
				<Entry />
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[stage]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="443" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [stage].[CleanStage]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlTable" Name="[stage].[FBAdaccounts]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBAdaccounts].[id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="25" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBAdaccounts].[account_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="25" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBAdaccounts].[business_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="25" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBAdaccounts].[name]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBAdaccounts].[timezone_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBAdaccounts].[timezone_name]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="100" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBAdaccounts].[timezone_offset_hours_utc]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[bigint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[stage]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlTable" Name="[stage].[FBAds]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBAds].[account_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="25" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBAds].[campaign_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="25" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBAds].[campaign_name]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBAds].[id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="25" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBAds].[name]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[stage]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlTable" Name="[stage].[FBBusinessAccounts]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBBusinessAccounts].[id]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="25" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBBusinessAccounts].[name]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[stage]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlTable" Name="[stage].[FBCampaignInsightsUTC]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBCampaignInsightsUTC].[campaign_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="25" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBCampaignInsightsUTC].[fb_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBCampaignInsightsUTC].[insight_utc_date]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Scale" Value="7" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetimeoffset]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBCampaignInsightsUTC].[spend]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Scale" Value="2" />
									<Property Name="Precision" Value="12" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[decimal]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBCampaignInsightsUTC].[dls]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[smallint]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
						<AttachedAnnotation Disambiguator="4" />
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[stage]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlTable" Name="[stage].[FBCampaigns]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBCampaigns].[account_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="25" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBCampaigns].[campaign_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="25" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBCampaigns].[campaign_name]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[stage]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlTable" Name="[stage].[FBInsights]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBInsights].[account_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="25" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBInsights].[ad_id]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="25" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBInsights].[spend]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Scale" Value="2" />
									<Property Name="Precision" Value="18" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[decimal]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBInsights].[date_start]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[date]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBInsights].[hs_by_advertiser_time_zone]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="20" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[stage]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlTable" Name="[stage].[FBObjectStorySpec]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBObjectStorySpec].[campaign_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="25" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBObjectStorySpec].[ad_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="25" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBObjectStorySpec].[adcreative_id]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="25" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[FBObjectStorySpec].[link]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="500" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[stage]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlProcedure" Name="[stage].[Load_CakeCampaignInsightsUTC]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET DATEFIRST 7
	/* Test comment 6 */
	DECLARE @USDLS smallint, @cake_timezone_offset_hours_utc int
	
	SELECT @cake_timezone_offset_hours_utc = SettingValue FROM [dbo].[Settings] WHERE SettingName = 'CAKETimeZoneOffsetHoursUTC'
	
	SET @USDLS = [dbo].[GetUSDaylightSaving](@InightsDate)
	SET @cake_timezone_offset_hours_utc = 60 * (@cake_timezone_offset_hours_utc + @USDLS)

	MERGE INTO [stage].[CakeCampaignInsightsUTC] cu
	USING(
			SELECT 
				ISNULL(cl.affiliate_id, cc.affiliate_id) as affiliate_id, 
				ISNULL(cl.campaign_id, cc.campaign_id) as campaign_id, 
				ISNULL(cl.subid_3, cc.subid_3) as fb_id, 
				SWITCHOFFSET(TODATETIMEOFFSET(DATEADD(HOUR, ISNULL(cc.conversion_hour, 0), CAST(ISNULL(cl.click_date, cc.conversion_date) as DateTime)), @cake_timezone_offset_hours_utc), '+00:00')  as insight_utc_date,
				ISNULL(cc.Revenue, 0) AS revenue,
				dls = @USDLS
			FROM (SELECT DISTINCT affiliate_id, campaign_id, CAST(click_date AS DATE) AS click_date, subid_3 FROM [stage].[CakeClicks] WHERE campaign_id > 0 AND CAST(click_date AS DATE) = @InightsDate) cl
				FULL JOIN (
							SELECT cc.affiliate_id, cc.campaign_id, RTRIM(LTRIM(cc.subid_3)) as subid_3, CAST(cc.conversion_date AS DATE) as conversion_date, 
														DATEPART(HOUR,cc.conversion_date) as conversion_hour, 
														cc.price_paid as price,
														cc.price_paid * count(*) as Revenue
							FROM [stage].[CakeConversions] cc
							WHERE CAST(cc.conversion_date as date) = @InightsDate
							GROUP BY cc.affiliate_id, cc.campaign_id, CAST(cc.conversion_date AS DATE), DATEPART(HOUR,cc.conversion_date), cc.[price_paid], cc.subid_3) cc 
			ON cc.subid_3 = cl.subid_3 AND cc.campaign_id = cl.campaign_id AND cc.conversion_date = cl.click_date
		)n ON (n.affiliate_id = cu.affiliate_id AND n.campaign_id = cu.campaign_id AND n.fb_id = cu.fb_id AND n.insight_utc_date = cu.insight_utc_date)
	WHEN MATCHED THEN
		UPDATE SET
			revenue = n.revenue
	WHEN NOT MATCHED THEN
		INSERT
		(
			[affiliate_id],
			[campaign_id],
			[fb_id],
			[insight_utc_date],
			[revenue],
			[dls]
		)
		VALUES
		(
			n.[affiliate_id],
			n.[campaign_id],
			n.[fb_id],
			n.[insight_utc_date],
			n.[revenue],
			n.[dls]
		);
END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[smallint]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Settings]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Settings].[SettingValue]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[Settings].[SettingName]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetUSDaylightSaving]" />
				</Entry>
				<Entry>
					<References Name="[stage].[Load_CakeCampaignInsightsUTC].[@InightsDate]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeClicks]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeClicks].[affiliate_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeClicks].[campaign_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[date]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeClicks].[click_date]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeClicks].[subid_3]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[date]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeConversions]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeConversions].[affiliate_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeConversions].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeConversions].[subid_3]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[date]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeConversions].[conversion_date]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeConversions].[price_paid]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeConversions].[price_paid]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[date]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[date]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeClicks].[subid_3]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeConversions].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeClicks].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeClicks].[affiliate_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeConversions].[affiliate_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[datetime]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeCampaignInsightsUTC]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeCampaignInsightsUTC].[affiliate_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeCampaignInsightsUTC].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeCampaignInsightsUTC].[fb_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeCampaignInsightsUTC].[insight_utc_date]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeCampaignInsightsUTC].[revenue]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeCampaignInsightsUTC].[affiliate_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeCampaignInsightsUTC].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeCampaignInsightsUTC].[fb_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeCampaignInsightsUTC].[insight_utc_date]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeCampaignInsightsUTC].[dls]" />
				</Entry>
				<Entry />
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[stage].[Load_CakeCampaignInsightsUTC].[@InightsDate]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[date]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[stage]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="2342" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [stage].[Load_CakeCampaignInsightsUTC]&#xD;&#xA;&#x9;@InightsDate Date&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[stage].[Load_FBCampaignInsightsUTC]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	SET DATEFIRST 7

	DECLARE @USDLS smallint
	SET @USDLS = [dbo].[GetUSDaylightSaving](@InightsDate)


	MERGE INTO [stage].[FBCampaignInsightsUTC] fu
	USING(
			SELECT campaign_id = res.campaign_id
						,fb_id = res.fb_id
						,insight_utc_date = res.insight_utc_date
						,spend = SUM(res.spend)
						,dls = @USDLS
				FROM (
						SELECT 
								campaign_id = r.campaign_id
								,fb_id = r.fb_id
								,insight_utc_date = SWITCHOFFSET(r.insight_utc_date, '+00:00') 
								,spend = r.spend
						FROM (
								SELECT campaign_id = c.campaign_id
										,fb_id = ISNULL([dbo].[GetLinkParameterValue](os.link, 'c2'), [dbo].[GetLinkParameterValue](os.link, 's3'))
										,insight_utc_date = TODATETIMEOFFSET(cast(cast(i.date_start as varchar(10)) + ' ' + CAST(i.[hs_by_advertiser_time_zone] as varchar(8)) as DateTime),  60 * (a.timezone_offset_hours_utc + @USDLS))
										,spend = SUM(ISNULL(i.spend, 0))
								FROM [stage].[FBAdaccounts] a
									INNER JOIN [stage].[FBCampaigns] c ON c.account_id = a.account_id
									INNER JOIN [stage].[FBAds] ad ON ad.campaign_id = c.campaign_id
									INNER JOIN [stage].[FBInsights] i ON i.ad_id = ad.id AND i.[date_start] = @InightsDate
									INNER JOIN [stage].[FBObjectStorySpec] os ON os.ad_id = ad.id
								GROUP BY a.business_id, a.account_id, c.campaign_id, i.date_start, i.hs_by_advertiser_time_zone, os.link, a.timezone_id, a.timezone_offset_hours_utc
								UNION ALL 
								SELECT campaign_id = e.campaign_id
										,fb_id = e.fb_id 
										,insight_utc_date = TODATETIMEOFFSET(CAST(cast(@InightsDate as varchar(10)) + ' 12:00:00' AS DATETIME),  60 * (e.timezone_offset_hours_utc + @USDLS))
										,spend = 0
								FROM (SELECT c.campaign_id,
												ISNULL([dbo].[GetLinkParameterValue](os.link, 'c2'), [dbo].[GetLinkParameterValue](os.link, 's3')) as fb_id,
												i.date_start,
												a.[timezone_id], 
												a.timezone_offset_hours_utc
										FROM [stage].[FBAdaccounts] a
											INNER JOIN [stage].[FBCampaigns] c ON c.account_id = a.account_id
											INNER JOIN [stage].[FBAds] ad ON ad.campaign_id = c.campaign_id
											LEFT JOIN [stage].[FBInsights] i ON i.ad_id = ad.id AND i.[date_start] = @InightsDate
											INNER JOIN [stage].[FBObjectStorySpec] os ON os.ad_id = ad.id
										GROUP BY a.business_id, a.account_id, c.campaign_id, i.date_start, i.hs_by_advertiser_time_zone, os.link, a.timezone_id, a.timezone_offset_hours_utc) e
								GROUP BY e.campaign_id, e.fb_id, e.[timezone_id], e.timezone_offset_hours_utc
								HAVING COUNT(*) = 1 AND MIN(e.date_start) IS NULL) r) res
				WHERE res.fb_id IS NOT NULL
				GROUP BY res.campaign_id, res.fb_id, res.insight_utc_date
		)n ON (n.campaign_id = fu.campaign_id AND n.fb_id = fu.fb_id AND n.insight_utc_date = fu.insight_utc_date)
	WHEN MATCHED THEN
		UPDATE SET
			spend = n.spend
	WHEN NOT MATCHED THEN
		INSERT
		(
			[campaign_id],
			[fb_id],
			[insight_utc_date],
			[spend],
			[dls]
		)
		VALUES
		(
			n.[campaign_id],
			n.[fb_id],
			n.[insight_utc_date],
			n.[spend],
			n.[dls]
		);
END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[smallint]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetUSDaylightSaving]" />
				</Entry>
				<Entry>
					<References Name="[stage].[Load_FBCampaignInsightsUTC].[@InightsDate]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[account_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[account_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAds]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAds].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBInsights]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBInsights].[ad_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAds].[id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBInsights].[date_start]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBObjectStorySpec]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBObjectStorySpec].[ad_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAds].[id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetLinkParameterValue]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBObjectStorySpec].[link]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[datetime]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBInsights].[date_start]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBInsights].[hs_by_advertiser_time_zone]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[timezone_offset_hours_utc]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBInsights].[spend]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[business_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[account_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[timezone_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[account_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[account_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAds].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBInsights].[ad_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAds].[id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBInsights].[date_start]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBObjectStorySpec].[ad_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAds].[id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[dbo].[GetLinkParameterValue]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBObjectStorySpec].[link]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBInsights].[date_start]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[timezone_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[timezone_offset_hours_utc]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[business_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[account_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBInsights].[hs_by_advertiser_time_zone]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_id]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[datetime]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[timezone_offset_hours_utc]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[timezone_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBInsights].[date_start]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaignInsightsUTC]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaignInsightsUTC].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaignInsightsUTC].[fb_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaignInsightsUTC].[insight_utc_date]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaignInsightsUTC].[spend]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaignInsightsUTC].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaignInsightsUTC].[fb_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaignInsightsUTC].[insight_utc_date]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaignInsightsUTC].[dls]" />
				</Entry>
				<Entry />
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[stage].[Load_FBCampaignInsightsUTC].[@InightsDate]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[date]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[stage]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="3263" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [stage].[Load_FBCampaignInsightsUTC]&#xD;&#xA;&#x9;@InightsDate Date&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlTable" Name="[stage].[StageErrorLog]">
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[StageErrorLog].[Id]">
						<Property Name="IsNullable" Value="False" />
						<Property Name="IsIdentity" Value="True" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[int]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[StageErrorLog].[Date]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[StageErrorLog].[PackageName]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[StageErrorLog].[TaskName]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="255" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[StageErrorLog].[SourceName]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="50" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[stage].[StageErrorLog].[Message]">
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="1000" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[stage]" />
				</Entry>
			</Relationship>
			<AttachedAnnotation Disambiguator="17" />
		</Element>
		<Element Type="SqlSchema" Name="[test]">
			<Relationship Name="Authorizer">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlSchema" Name="[utils]">
			<Relationship Name="Authorizer">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[dbo]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlMultiStatementTableValuedFunction" Name="[utils].[CSVToTable]">
			<Property Name="ReturnTableVariable" Value="@TempTab" />
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[int]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References Name="[utils].[CSVToTable].[@InStr]" />
				</Entry>
				<Entry>
					<References Name="[utils].[CSVToTable].[@sep]" />
				</Entry>
				<Entry>
					<References Name="[utils].[CSVToTable].[value]" />
				</Entry>
			</Relationship>
			<Relationship Name="Columns">
				<Entry>
					<Element Type="SqlSimpleColumn" Name="[utils].[CSVToTable].[value]">
						<Property Name="IsNullable" Value="False" />
						<Relationship Name="TypeSpecifier">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="FunctionBody">
				<Entry>
					<Element Type="SqlScriptFunctionImplementation">
						<Property Name="BodyScript">
							<Value><![CDATA[
BEGIN
    ;-- Ensure input ends with comma
	SET @InStr = replace(@InStr + @sep, @sep+@sep, @sep)
	DECLARE 
		@SP int, 
		@len int, 
		@spos int, @fpos int
	DECLARE @value1 varchar(1000)

	SET @len = LEN(@InStr);
	SET @spos = 1; SET @fpos = 1;
	WHILE @fpos <= @len BEGIN
		IF SUBSTRING(@InStr, @fpos, 1) = @sep BEGIN	
			INSERT INTO @TempTab(value) VALUES (ltrim(rtrim(SUBSTRING(@InStr, @spos, @fpos - @spos))));

			SET @fpos = @fpos + 1; 
			SET @spos = @fpos;
		END ELSE 
			SET @fpos = @fpos + 1;
	END;
	RETURN
END]]></Value>
						</Property>
						<Annotation Type="SysCommentsObjectAnnotation">
							<Property Name="Length" Value="674" />
							<Property Name="StartLine" Value="1" />
							<Property Name="StartColumn" Value="1" />
							<Property Name="HeaderContents" Value="CREATE FUNCTION [utils].[CSVToTable] (@InStr varchar(max), @sep char(1))&#xD;&#xA;RETURNS @TempTab TABLE&#xD;&#xA;   (value varchar(max) NOT NULL)&#xD;&#xA;AS" />
						</Annotation>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[utils].[CSVToTable].[@InStr]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="IsMax" Value="True" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[varchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[utils].[CSVToTable].[@sep]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="1" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[char]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[utils]" />
				</Entry>
			</Relationship>
		</Element>
		<Element Type="SqlProcedure" Name="[utils].[GetAdDetails]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	
	SELECT c.campaign_name, a.name, os.link
	FROM [stage].[FBAds] a
		INNER JOIN [stage].[FBObjectStorySpec] os ON a.id = os.ad_id
		INNER JOIN [stage].[FBCampaigns] c ON a.campaign_id = c.campaign_id
	WHERE a.campaign_id = @campaignid
	AND os.link like '%' + @FB_ID + '%'

END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[stage].[FBAds]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBObjectStorySpec]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAds].[id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBObjectStorySpec].[ad_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAds].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_name]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAds].[name]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBObjectStorySpec].[link]" />
				</Entry>
				<Entry>
					<References Name="[utils].[GetAdDetails].[@campaignid]" />
				</Entry>
				<Entry>
					<References Name="[utils].[GetAdDetails].[@FB_ID]" />
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[utils].[GetAdDetails].[@campaignid]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="25" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[utils].[GetAdDetails].[@FB_ID]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Property Name="Length" Value="50" />
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[nvarchar]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[utils]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="386" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [utils].[GetAdDetails]&#xD;&#xA;&#x9;@campaignid nvarchar(25),&#xD;&#xA;&#x9;@FB_ID nvarchar(50)&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[utils].[GetDaysRange]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	
	IF @DateFrom > @DateTo RETURN;

	WITH lst AS (
		SELECT cast(cast(@DateFrom as date) as datetime) AS dt
		UNION ALL
		SELECT DATEADD(dd, 1, dt) dt
		  FROM lst s 
		 WHERE DATEADD(dd, 1, dt) < @DateTo )

	SELECT DateFrom, DateTo
	FROM (SELECT dt as DateFrom, LEAD(dt) OVER(order by dt) as DateTo
			FROM (SELECT CONVERT(VARCHAR(20), CAST(@DateFrom AS DateTime), 120) as dt
			UNION
			SELECT DISTINCT CONVERT(VARCHAR(20), dt, 120) FROM lst  WHERE dt > cast(@DateFrom as date) AND dt <= cast(@DateTo as date)
			UNION
			SELECT CONVERT(VARCHAR(20), CAST(@DateTo AS DateTime), 120) as dt) r) res
	WHERE res.DateTo IS NOT NULL
	OPTION (maxrecursion 0)


END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[utils].[GetDaysRange].[@DateFrom]" />
				</Entry>
				<Entry>
					<References Name="[utils].[GetDaysRange].[@DateTo]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[datetime]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[date]" />
				</Entry>
				<Entry>
					<References Name="[utils].[GetDaysRange].[CTE1].[lst].[dt]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[datetime]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[date]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[date]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[varchar]" />
				</Entry>
				<Entry>
					<References ExternalSource="BuiltIns" Name="[datetime]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[utils].[GetDaysRange].[CTE1].[lst]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[utils].[GetDaysRange].[CTE1].[lst].[dt]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Parameters">
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[utils].[GetDaysRange].[@DateFrom]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
				<Entry>
					<Element Type="SqlSubroutineParameter" Name="[utils].[GetDaysRange].[@DateTo]">
						<Relationship Name="Type">
							<Entry>
								<Element Type="SqlTypeSpecifier">
									<Relationship Name="Type">
										<Entry>
											<References ExternalSource="BuiltIns" Name="[datetime]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[utils]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="771" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [utils].[GetDaysRange]&#xD;&#xA;&#x9;@DateFrom DateTime,&#xD;&#xA;&#x9;@DateTo DateTime&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[utils].[GetDoubleCampaignsId]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	
IF OBJECT_ID('tempdb..#ss') IS NOT NULL
	DROP TABLE #ss


SELECT DISTINCT
account_id = r.account_id
,account_name = r.name
,campaign_name = r.campaign_name
,campaign_id = r.campaign_id
,fb_id = SUBSTRING(r.fb_id, 0, CASE WHEN CHARINDEX('&', r.fb_id, 0) > 0 THEN CHARINDEX('&', r.fb_id, 0) ELSE LEN(r.fb_id) + 1  END)
		INTO #ss
FROM (
		SELECT a.account_id, a.name, campaign_id = c.campaign_id, c.campaign_name
				,fb_id = SUBSTRING(os.link, CHARINDEX('&c2=', os.link, 0) + 4, LEN(os.link)) 
							
		FROM [stage].[FBAdaccounts] a
			INNER JOIN [stage].[FBCampaigns] c ON c.account_id = a.account_id
			INNER JOIN [stage].[FBAds] ad ON ad.campaign_id = c.campaign_id
			INNER JOIN [stage].[FBObjectStorySpec] os ON os.ad_id = ad.id
	)r


SELECT account_name, campaign_name, campaign_id, fb_id FROM #ss 
WHERE campaign_id IN (SELECT campaign_id FROM #ss group by campaign_id having count(*) > 1)
AND fb_id like '%fb-%'
ORDER BY campaign_name


END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[utils].[GetDoubleCampaignsId].[#ss]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[account_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[account_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAds]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAds].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBObjectStorySpec]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBObjectStorySpec].[ad_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAds].[id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[account_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[name]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_name]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBObjectStorySpec].[link]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[account_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[name]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_name]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[utils].[GetDoubleCampaignsId].[#ss].[account_name]" />
				</Entry>
				<Entry>
					<References Name="[utils].[GetDoubleCampaignsId].[#ss].[campaign_name]" />
				</Entry>
				<Entry>
					<References Name="[utils].[GetDoubleCampaignsId].[#ss].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[utils].[GetDoubleCampaignsId].[#ss].[fb_id]" />
				</Entry>
				<Entry>
					<References Name="[utils].[GetDoubleCampaignsId].[#ss].[campaign_id]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[utils].[GetDoubleCampaignsId].[#ss]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[utils].[GetDoubleCampaignsId].[#ss].[account_id]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[stage].[FBAdaccounts].[account_id]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[utils].[GetDoubleCampaignsId].[#ss].[account_name]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[stage].[FBAdaccounts].[name]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[utils].[GetDoubleCampaignsId].[#ss].[campaign_name]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[stage].[FBCampaigns].[campaign_name]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[utils].[GetDoubleCampaignsId].[#ss].[campaign_id]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[stage].[FBCampaigns].[campaign_id]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[utils].[GetDoubleCampaignsId].[#ss].[fb_id]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[utils]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="1039" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [utils].[GetDoubleCampaignsId]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
		<Element Type="SqlProcedure" Name="[utils].[GetDoubleFbIds]">
			<Property Name="BodyScript">
				<Value><![CDATA[
BEGIN
	
IF OBJECT_ID('tempdb..#ss') IS NOT NULL
	DROP TABLE #ss


SELECT DISTINCT
account_id = r.account_id
,account_name = r.name
,campaign_name = r.campaign_name
,campaign_id = r.campaign_id
,fb_id = SUBSTRING(r.fb_id, 0, CASE WHEN CHARINDEX('&', r.fb_id, 0) > 0 THEN CHARINDEX('&', r.fb_id, 0) ELSE LEN(r.fb_id) + 1  END)
		INTO #ss
FROM (
		SELECT a.account_id, a.name, campaign_id = c.campaign_id, c.campaign_name
				,fb_id = SUBSTRING(os.link, CHARINDEX('&c2=', os.link, 0) + 4, LEN(os.link)) 
							
		FROM [stage].[FBAdaccounts] a
			INNER JOIN [stage].[FBCampaigns] c ON c.account_id = a.account_id
			INNER JOIN [stage].[FBAds] ad ON ad.campaign_id = c.campaign_id
			INNER JOIN [stage].[FBObjectStorySpec] os ON os.ad_id = ad.id
	)r


SELECT account_name, campaign_name, campaign_id, fb_id from 
(
	SELECT * FROM #ss 
	WHERE fb_id IN (SELECT fb_id FROM #ss group by fb_id having count(*) > 1)
) r
where  (r.fb_id like '%fb-%' OR r.fb_id like '%alpha%')
and r.fb_id in (select distinct subid_3 from [stage].[CakeClicks])
order by fb_id, campaign_Name

END]]></Value>
			</Property>
			<Property Name="IsAnsiNullsOn" Value="True" />
			<Relationship Name="BodyDependencies">
				<Entry>
					<References Name="[utils].[GetDoubleFbIds].[#ss]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[account_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[account_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAds]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAds].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBObjectStorySpec]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBObjectStorySpec].[ad_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAds].[id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[account_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[name]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_name]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBObjectStorySpec].[link]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[account_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBAdaccounts].[name]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_name]" />
				</Entry>
				<Entry>
					<References Name="[stage].[FBCampaigns].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[utils].[GetDoubleFbIds].[#ss].[fb_id]" />
				</Entry>
				<Entry>
					<References Name="[utils].[GetDoubleFbIds].[#ss].[fb_id]" />
				</Entry>
				<Entry>
					<References Name="[utils].[GetDoubleFbIds].[#ss].[account_name]" />
				</Entry>
				<Entry>
					<References Name="[utils].[GetDoubleFbIds].[#ss].[campaign_name]" />
				</Entry>
				<Entry>
					<References Name="[utils].[GetDoubleFbIds].[#ss].[campaign_id]" />
				</Entry>
				<Entry>
					<References Name="[utils].[GetDoubleFbIds].[#ss].[fb_id]" />
				</Entry>
				<Entry>
					<References Name="[utils].[GetDoubleFbIds].[#ss].[fb_id]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeClicks]" />
				</Entry>
				<Entry>
					<References Name="[stage].[CakeClicks].[subid_3]" />
				</Entry>
			</Relationship>
			<Relationship Name="DynamicObjects">
				<Entry>
					<Element Type="SqlDynamicColumnSource" Name="[utils].[GetDoubleFbIds].[#ss]">
						<Relationship Name="Columns">
							<Entry>
								<Element Type="SqlComputedColumn" Name="[utils].[GetDoubleFbIds].[#ss].[account_id]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[stage].[FBAdaccounts].[account_id]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[utils].[GetDoubleFbIds].[#ss].[account_name]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[stage].[FBAdaccounts].[name]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[utils].[GetDoubleFbIds].[#ss].[campaign_name]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[stage].[FBCampaigns].[campaign_name]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[utils].[GetDoubleFbIds].[#ss].[campaign_id]">
									<Relationship Name="ExpressionDependencies">
										<Entry>
											<References Name="[stage].[FBCampaigns].[campaign_id]" />
										</Entry>
									</Relationship>
								</Element>
							</Entry>
							<Entry>
								<Element Type="SqlComputedColumn" Name="[utils].[GetDoubleFbIds].[#ss].[fb_id]" />
							</Entry>
						</Relationship>
					</Element>
				</Entry>
			</Relationship>
			<Relationship Name="Schema">
				<Entry>
					<References Name="[utils]" />
				</Entry>
			</Relationship>
			<Annotation Type="SysCommentsObjectAnnotation">
				<Property Name="Length" Value="1147" />
				<Property Name="StartLine" Value="1" />
				<Property Name="StartColumn" Value="1" />
				<Property Name="HeaderContents" Value="CREATE PROCEDURE [utils].[GetDoubleFbIds]&#xD;&#xA;AS" />
			</Annotation>
		</Element>
	</Model>
</DataSchemaModel>